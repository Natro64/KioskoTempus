/*!
* Data Aquarium Framework - Charts for Touch UI
* Copyright 2008-2015 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function e(n){return n.match(/pie|donut/i)}function n(n,t,i,r){i||(i="visualization");r||(r="1");var f=i+r+(typeof n=="string"?n:n.join("-")),u=s[f];u&&u.loaded?t():u&&!u.loaded?u.callbacks.push(t):($app.touch.busyIndicator(!0),u=s[f]={loaded:!1,callbacks:[t]},google.load(i,r,{packages:n,callback:function(){$app.touch.busyIndicator(!1);u.loaded=!0;$(u.callbacks).each(function(){this()})}}))}function c(t,i){var u=$('<div class="app-chart-headerbar"><\/div>').appendTo(i),e=$('<div class="app-chart-mini"><\/div>').appendTo(u).attr("title",r.ShowChart),s=t.Properties.title||t.Title,a=$('<span class="app-chart-header"><\/span>').appendTo(u),f=$('<div class="app-chart-data app-scrollable"><\/div>').appendTo(i),h=$("<table><\/table>").appendTo(f),c=!t.ChartType.match(/map|table/);c||e.hide();i.closest(".app-chart").addClass("app-chart-has-data");t.ShowData=!0;n("corechart",function(){var r=google.visualization.arrayToDataTable(t.ChartData),p=r.getNumberOfRows(),y=r.getNumberOfColumns(),v=$("<tr><\/tr>").appendTo(h),u,i,n,f;for(a.text(s.substring(0,1).toUpperCase()+s.substring(1)),l(t,r),i=0;i<y;i++)n=r.getColumnLabel(i),f=$("<th><\/th>").appendTo(v),n!=null&&f.text(n).attr("title",n);for(u=0;u<p;u++)for(v=$("<tr><\/tr>").appendTo(h),i=0;i<y;i++)n=r.getFormattedValue(u,i),f=$("<td><\/td>").appendTo(v),n!=null&&f.text(n=="0"?"":n).attr("title",n);c&&o(t,e)});f.height(Math.floor(i.height()-u.outerHeight(!0)));f.width(i.width())}function o(n,t){var i=a[n.ChartType];i&&i(n,t)}function t(n,t,i){var u=e(n.ChartType),h=n.Properties.title||n.Title,o,r,f,s;i||(i={});i.legend||(i.legend={});i.hAxis||(i.hAxis={});i.vAxis||(i.vAxis={});i.chartArea||(i.chartArea={});i.tooltip||(i.tooltip={});i.title=h.charAt(0).toUpperCase()+h.slice(1);i.width=Math.floor(t.width())-1;i.height=Math.floor(t.height())-1;i.tooltip.trigger="focus";n.ChartData[0].length<=2&&(u||(i.legend.position="none"),u&&(n.Properties.maximize=!0));u&&(i.sliceVisibilityThreshold=0);for(o in n.Properties)if(n.Properties.hasOwnProperty(o)){r=n.Properties[o];switch(o){case"crosshair":i.crosshair={orientation:r==0?"both":r,trigger:"both"};break;case"maximize":u?(i.chartArea.top="15%",i.chartArea.width="80%",i.chartArea.height="80%"):(i.titlePosition="in",i.chartArea.width="100%",i.chartArea.height="100%",i.legend.position||(i.legend.position="in"));i.axisTitlesPosition="in";i.hAxis.textPosition="in";i.vAxis.textPosition="in";break;case"haxistitle":i.hAxis.title=r;break;case"vaxistitle":i.vAxis.title=r;break;case"region":i.region=r;break;case"displaymode":i.displayMode=r;break;case"resolution":i.resolution=r;break;case"curve":i.curveType="function";break;case"explorer":i.explorer={};break;case"maptype":i.mapType=r;break;case"enablescrollwheel":i.enableScrollWheel=!0;break;case"usemaptypecontrol":i.useMapTypeControl=!0;break;case"pointshape":i.pointShape=r;break;case"pointsize":i.pointSize=r;break;case"orientation":i.orientation=r;break;case"animation":i.animation={startup:!0,duration:500,easing:"out"};break;case"colors":f=r.split(",");for(s in f)f[s]=f[s].trim();i.colors=f}}return n.ShowData&&(i.legend.position="none",i.axisTitlesPosition="none",i.height="100%",i.titlePosition="none",i.chartArea.top="0",i.chartArea.width="100%",i.chartArea.height="100%",i.enableInteractivity=!1),$("body").hasClass("app-theme-dark")&&(i.backgroundColor="#1f1f1f",i.hAxis.textStyle={color:"white"},i.hAxis.gridlines={color:"#000"},i.vAxis.textStyle={color:"white"},i.vAxis.gridlines={color:"#000"},i.legend.textStyle={color:"#999"},i.legend.scrollArrows={activeColor:"#fff",inactiveColor:"#777"},i.legend.pagingTextStyle={color:"#999"},i.titleTextStyle={color:"white"},u&&(i.pieSliceBorderColor="#111")),i}function l(n,t){var o=n.ValueFieldNames.length,c=n.ValueFieldNames.length,r;for(name in n.Formats){var i=n.Formats[name],u=/(\w+)(\d)/.exec(name),s=u[1],h=u[2],f=n.ValueFieldNames.indexOf(s,h),e;if(f!=-1&&i){switch(i.toLowerCase()){case"c":case"C":i="Â¤00.00";break;case"d":case"D":i="00.00";break;case"e":case"E":i="0.######E+000";break;case"f":case"F":i="00.00";break;case"n":case"N":i="00.00";break;case"p":case"P":i="%";break;case"x":case"X":i="00.00"}for(e=new google.visualization.NumberFormat({pattern:i}),r=f+1;r<n.Data[0].length;r=r+o)e.format(t,r)}}}function i(n,t,i,r){function o(){}var f=google.visualization.arrayToDataTable(n.ChartData),e=n.ChartType.match(/geo/i);l(n,f);u.desktop()||e||o();n.Properties.animation&&!e&&n.ChartType!="map"&&i.draw(null,r);i.draw(f,r);u.desktop()&&!e&&(google.visualization.events.addListener(i,"select",function(){if(r.tooltip.trigger=="focus"){r.tooltip.trigger="selection";var n=i.getSelection();return o(),i.draw(f,r),i.setSelection(n),!1}}),google.visualization.events.addListener(i,"click",function(n){n.targetID.match(/^action/)||r.tooltip.trigger!="selection"||(r.tooltip.trigger="focus",i.removeAction("filter"),i.removeAction("exclude"),i.setSelection(null),i.draw(f,r))}))}var v=$(window),y=$.mobile,u=$app.touch,s={},r=Web.DataViewResources.Presenters.Charts,f=Web.DataViewResources.Mobile,h,a;$(document).on("resizing.app searching.app",function(){$.mobile.activePage.find(".app-chart-inner").children().hide()}).on("vclick",".app-chart",function(n){function w(){delete e.ShowData;i.viewProp("chartsConfig",l);var r=t.closest(".app-chart-list").parent().data("pivots")["pivot"+p],n=t.closest(".app-chart").find(".app-chart-inner");n.empty();n.closest(".app-chart").removeClass("app-chart-has-data");r.ShowData=!1;o(r,n)}var t=$(n.target),b=t.closest(".app-echo"),i=b.length?$app.find(b.attr("data-for")):u.dataView(),h=t.closest(".app-chart").data("data-context");if(i&&h){var p=h.Id,l=i.viewProp("chartsConfig"),e=l&&l[p],v=!$("body").hasClass("app-sidebar-undocked"),y=$(window).width()/parseFloat($("body").css("font-size")),k=v&&y>=50||!v&&y>=40,d=v&&y>=85||!v&&y>=62,a=e.size?e.size:"small",s=[];return t.is(".app-btn-more")&&!$app.mobile.busy()?($app.mobile.callWithFeedback(t.closest(".ui-btn"),function(){a!="large"||d||(a="medium");a!="medium"||k||(a="small");var n=t.closest(".app-chart-list").parent().data("pivots")["pivot"+p];n.ChartType.match(/map|table/)||(e.ShowData?s.push({text:r.ShowChart,icon:"chart",callback:w}):s.push({text:r.ShowData,icon:"grid",callback:function(){e.ShowData=!0;i.viewProp("chartsConfig",l);var r=t.closest(".app-chart").find(".app-chart-inner");r.empty();c(n,r)}}));t.closest(".app-chart-list").find(".app-chart").length>1?(s.push({text:r.Sizes.Label}),s.push({text:r.Sizes.Small,icon:a=="small"?"check":"",callback:function(){delete e.size;e.resized=!0;i.viewProp("chartsConfig",l);$app.touch.presenter("show",{name:"Charts",id:i._id,container:t.closest(".app-wrapper")})}}),k&&s.push({text:r.Sizes.Medium,icon:a=="medium"?"check":"",callback:function(){e.size="medium";e.resized=!0;i.viewProp("chartsConfig",l);$app.touch.presenter("show",{name:"Charts",id:i._id,container:t.closest(".app-wrapper")})}}),d&&s.push({text:r.Sizes.Large,icon:a=="large"?"check":"",callback:function(){e.size="large";e.resized=!0;i.viewProp("chartsConfig",l);$app.touch.presenter("show",{name:"Charts",id:i._id,container:t.closest(".app-wrapper")})}})):s.push({text:r.Sizes.Auto,icon:"check",callback:function(){}});s.push({text:f.Filter});h.ColumnFieldNames&&h.ColumnFieldNames.length&&s.push({text:i.findField(h.ColumnFieldNames[0]).HeaderText,icon:"filter",callback:function(){u.configureFilter({field:h.ColumnFieldNames[0],scope:i._id,mode:"field"})}});h.RowFieldNames&&h.RowFieldNames.length&&s.push({text:i.findField(h.RowFieldNames[0]).HeaderText,icon:"filter",callback:function(){u.configureFilter({field:h.RowFieldNames[0],scope:i._id,mode:"field"})}});u.listPopup({anchor:t.closest("a"),iconPos:"right",items:s})}),!1):t.closest(".app-chart-mini").length?(w(),!1):void 0}}).on("taphold",".app-chart",function(n){var t=$(n.target);t.is("td")&&t.closest(".app-chart-data").length&&u.listPopup({anchor:t,title:t.text()})});a={area:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.AreaChart($(u).get(0));i(r,u,f,n)})},areastacked:function(r,u){n("corechart",function(){var n=t(r,u,{isStacked:!0}),f=new google.visualization.AreaChart($(u).get(0));i(r,u,f,n)})},bar:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.BarChart($(u).get(0));i(r,u,f,n)})},barstacked:function(r,u){n("corechart",function(){var n=t(r,u,{isStacked:!0}),f=new google.visualization.BarChart($(u).get(0));i(r,u,f,n)})},column:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.ColumnChart($(u).get(0));i(r,u,f,n)})},columnstacked:function(r,u){n("corechart",function(){var n=t(r,u,{isStacked:!0}),f=new google.visualization.ColumnChart($(u).get(0));i(r,u,f,n)})},candlestick:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.CandlestickChart($(u).get(0));i(r,u,f,n)})},donut:function(r,u){n("corechart",function(){var n=t(r,u,{pieHole:.4,backgroundColor:"transparent"}),f=new google.visualization.PieChart($(u).get(0));i(r,u,f,n)})},geo:function(r,u){n("geochart",function(){var n=t(r,u,{backgroundColor:"transparent"}),f=new google.visualization.GeoChart($(u).get(0));i(r,u,f,n)})},map:function(r,u){n("map",function(){var n=t(r,u,{showTip:!0}),f=new google.visualization.Map($(u).get(0));i(r,u,f,n)})},line:function(r,u){n("corechart",function(){var n=t(r,u,{showTip:!0}),f=new google.visualization.LineChart($(u).get(0));i(r,u,f,n)})},pie:function(r,u){n("corechart",function(){var n=t(r,u,{title:r.Title,backgroundColor:"transparent"}),f=new google.visualization.PieChart($(u).get(0));i(r,u,f,n)})},pie3d:function(r,u){n("corechart",function(){var n=t(r,u,{backgroundColor:"transparent",is3D:!0}),f=new google.visualization.PieChart($(u).get(0));i(r,u,f,n)})},scatter:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.ScatterChart($(u).get(0));i(r,u,f,n)})},table:function(r,u){n("table",function(){var n=t(r,u),f=new google.visualization.Table($(u).get(0));i(r,u,f,n)})}};$app.touch.presenter("register",{name:"Charts",icon:function(){return"chart"},text:function(){return r.Text},supports:function(n){var u=!1;if($(n._fields).each(function(){if(this.Tag&&this.Tag.indexOf("pivot")!=-1)return u=!0,!1}),u)n.AutoPivots=null;else{if(n.AutoPivots&&$.isEmptyObject(n.AutoPivots))return!0;var t=1,g=n._fields[0].Label,i=[],o=0,v=0,h=["pie3d","column","donut","bar"],r=[],f=0,y=0,c=["line","column","area"],p=0,l=["columnstacked-top5","area-top7","column-top5","barstacked-top5"],w=[],a=n.groupExpression(),b=!1;n.AutoPivots={};function s(){return h[v++%h.length]}function k(){return c[y++%c.length]}function d(){return l[p++%l.length]}$(n._fields).each(function(){var u=this;n.AutoPivots[u.Name]=[];(u.ItemsDataController||u.AliasName)&&i.push(u.Name);u.Type=="DateTime"&&r.push(u.Name);u.DataFormatString=="c"&&w.push(u.Name);a&&a[0]==(u.AliasName||u.Name)&&n.AutoPivots[u.Name].push("pivot"+t+++"-row1-top10-sortdescbyvalue-"+(u.Type=="String"?"pie-other":"column"))});$(i).each(function(){if(t>9||!r[f])return!1;var u=this,e=r[f];n.AutoPivots[i[o++%i.length]].push("pivot"+t+"-col1-sortdescbyvalue-"+d());n.AutoPivots[r[f++%r.length]].push("pivot"+t+++"-row1-date-all-hideblank")});o=0;f=0;$(n._fields).each(function(){var u,r,f,h;if(t>9)return!1;if(u=this,r=u.Name,u.IsPrimaryKey)return!0;(u.ItemsDataController||u.AliasName)&&n.AutoPivots[r].push("pivot"+t+++"-row1-top10-other-sortdescbyvalue-"+s());switch(u.Type){case"Int16":case"Int32":case"Int64":case"Single":case"Double":case"Decimal":if(i.length!=0&&!(u.ItemsDataController||u.AliasName)){if(f="sum",h=s(),r.match(/salary/i))f="avg";else if(r.match(/total/i))f="sum";else if(u.DataFormatString=="{0:c}"||r.match(/price|discount/i))for(f="avg";e(h);)h=s();e(h)&&(f="sum");n.AutoPivots[r].push("pivot"+t+"-val1-"+f+"-"+h);n.AutoPivots[i[o++%i.length]].push("pivot"+t+++"-row1-top7-other-sortdescbyvalue")}break;case"DateTime":r.match(/birth|hire/i)?n.AutoPivots[r].push("pivot"+t+++"-row1-month-all-pie3d"):n.AutoPivots[r].push("pivot"+t+++"-row1-"+k()+"-date-all-hideblank");break;case"String":b||r.match(/country/i)&&n.AutoPivots[r].push("pivot"+t+++"-row1-geo")}});t>1&&(u=!0)}return u},show:function(n){function a(n){var u,e,o,s,h;v();u=$('<ul class="app-listview app-grid"/>').appendTo(i);n?(s=$('<li data-icon="filter" class="ui-last-child"><a href="#app-filter" class="ui-btn ui-icon-filter ui-btn-icon-left"><p/><\/a><\/li>').appendTo(u).find("a"),h=String.format(r.DataWarning,__settings.maxPivotRowCount),s.attr("title",f.Filter).find("p").text(h)):(e=$('<li data-icon="refresh"><a href="#app-refresh" class="ui-btn ui-icon-refresh ui-btn-icon-left"><p/><\/a><\/li>').appendTo(u).find("a"),e.attr("title",Web.DataViewResources.Pager.Refresh).find("p").text(Web.DataViewResources.Data.NoRecords),t._filter&&t._filter.length&&!t.filterIsExternal()&&(o=$('<li data-icon="filter" class="ui-last-child"><a href="#app-clear-filter" class="ui-btn ui-icon-filter ui-btn-icon-left"><p/><\/a><\/li>').appendTo(u).find("a"),o.attr("title",f.ClearFilter).find("p").text(f.ClearFilter)));u.listview()}function v(){i.find(".app-chart").each(function(){$(this).removeData()});i.empty()}function p(n){for(pivot in n)$(n[pivot].Data).each(function(){for(var t=this,n=0;n<t.length;)t[n]=y(t[n]),n++}),n[pivot].Title=y(n[pivot].Title),n[pivot].ChartData=JSON.parse(JSON.stringify(n[pivot].Data)),$(n[pivot].ChartData).each(function(){for(var i=this,t=this,n=0,n=0;n<t.length;n++)t[n]==null&&(t[n]=0)})}function y(n){if(!n||!isNaN(n)||isFinite(n))return n;var i=n.match(/\$(\S+)/g);return $(i).each(function(){var f=this.replace(/\d*/g,""),i=f.replace(/[$\d]*/g,""),u=r.ChartLabels[i];u?(i.match(/Quarter|Week/)&&(u=u.substring(0,1)),n=n.replace(f,u)):i=="CurrentViewLabel"&&(n=n.replace(f,t._view.Label));i=="Other"&&(n.isOther=!0)}),n}function l(){var p,l,h,n,b,tt=[],ft=0,k=i.closest(".app-wrapper"),it,y=0,nt=1,d,et=i.find(".app-chart"),rt,ut,g=!1,st,w,f;et.length>0&&(st=k.scrollTop(),$(et).each(function(){var n=$(this);if(n.position().top>0)return s[n.data("data-context").Id].lastScrollPosition=!0,!1}));v();$('<div class="app-chart"><span class="app-chart-inner"/><\/div><div class="app-chart"><span class="app-chart-inner"/><\/div><div class="app-chart"><span class="app-chart-inner"/><\/div>').appendTo(i);d=i.find(".app-chart");$(d[0]).offset().left<$(d[1]).offset().left&&nt++;$(d[1]).offset().left<$(d[2]).offset().left&&nt++;d.remove();i.empty();for(b in e)if(n=e[b],n.ChartType&&n.RecordCount!=0)g||(n.Properties.medium||n.Properties.large?g=!0:s&&(f=s[n.Id],f&&f.size&&f.size.match(/medium|large/)&&(g=!0))),y++;else continue;y==1&&(g=!0);for(b in e)(n=e[b],placeholder=$('<div class="app-chart"><\/div>').data("data-context",n),inner=$('<span class="app-chart-inner"><\/span>').appendTo(placeholder),moreBtn=$('<a class="ui-btn"><span class="app-btn-more">&nbsp;<\/span><\/a>').appendTo(placeholder).attr("title",r.More),n.ChartType&&n.RecordCount!=0)&&(placeholder.appendTo(i),p||(h=k.height(),it=k.find(".app-presenter-instruction:visible"),it.length&&(h-=it.outerHeight()),h=Math.floor(h),p=inner.width(),l=nt==3?y<=3?Math.min(h,p*1.33):Math.min(p*.66,Math.max(h/3,p*.5))-1:nt==2?y<=4?Math.max(h/2,p*.5):p*.66:h*.66,g&&y<=3&&(l=h*.5),l>h&&(l=p*.66,l>h&&(l=h)),l=Math.floor(l)),w=l,f=s[n.Id],f||(f=s[n.Id]={}),f.size||(n.Properties.small!=null?delete f.size:n.Properties.medium!=null?f.size="medium":n.Properties.large!=null&&(f.size="large")),f.size&&(f.size=="medium"?(y>2&&(w=l*2+1),placeholder.addClass("app-chart-medium")):f.size=="large"&&(w=h,placeholder.addClass("app-chart-large"))),y==1&&(placeholder.addClass("app-chart-large"),w=h),f.resized?(rt=placeholder,delete f.resized):f.lastScrollPosition&&(ut=placeholder,delete f.lastScrollPosition),f.ShowData||n.ChartType=="table"?n.ShowData=!0:n.ShowData&&(n.ShowData=!1),w<150&&(w=150),tt.push(inner.height(w)));if($('<div class="app-clear-fix"><\/div>').appendTo(i),setTimeout(function(){for(b in e)(n=e[b],n.ChartType&&n.RecordCount!=0)&&(n.ShowData?c(n,$(tt[ft++])):o(n,tt[ft++]))},10),y==0&&a(!1),i.closest(".app-echo").length==0&&$('<div class="app-promo-filler"><\/div>').appendTo(i),t.viewProp("chartsConfig",s),y>1&&(rt||ut)){var ot=rt||ut,ht=ot.outerHeight(),ct=(k.height()-ht)/2,lt=ot.offset().top-k.offset().top-ct;u.scroll(k,lt)}}var w=this,t=$app.find(n.id),b=t._filter,i=n.container.find(".app-chart-list"),e=n.container.data("pivots"),s=t.viewProp("chartsConfig")||{};if(i.length==0&&(i=$('<div class="app-chart-list"><\/div>').appendTo(n.container)),(n.reset||e&&t.dataSignature()!=n.container.data("signature"))&&(e=null),t._totalRowCount>__settings.maxPivotRowCount){a(!0);return}e&&e.length!=0?l():(i.find(".app-chart-inner").children().hide(),$app.execute({controller:t._controller,command:"Pivot",pivotDefinitions:t.AutoPivots,view:t._viewId,_filter:t.combinedFilter(),sort:"",tags:t.get_tags(),success:function(i){e=i.Pivots;p(e);n.container.data("signature",t.dataSignature());n.container.data("pivots",e);h?l():u.registerAPI("Charts",function(){h=!0;l()})},error:function(n){$app.alert(String.format("{0}\n{1}",n.get_message(),n.get_stackTrace()))}}))},hide:function(){},dispose:function(n){n.container.removeData("pivots signature");n.container.find("app-chart").each(function(){$(this).removeData()})}})})(),function(){function er(){return navigator.platform.match(/Win\d+|Mac/i)!=null&&(!navigator.maxTouchPoints||navigator.maxTouchPoints==0)}function ht(n){$('<div class="app-clear-fix"><\/div>').appendTo(n)}function or(){if(!ci){var n=new Date;ci=setTimeout(function(){yi=setInterval(o,6e4)},(60-n.getSeconds())*1e3)}}function o(t,i,r){var b,f;if(t||!$(".app-calendar.app-has-time-prompt").length){var u=t||new Date,h=e(u),v=$(".app-calendar-time"),s,l=v.find("div.app-current-time"),k=c-c/25,d=u.getTime(),y=u.getMinutes(),g=new Date(u.getFullYear(),u.getMonth(),u.getDate()).getTime(),nt=d-g,a=v.find("li span"),p=u.getMinutes(),w=15e3/c;return i&&y!=0&&(h=":"+y),i?i=="week"?($(".app-calendar").addClass("app-has-time-prompt"),s=ei.activePage.find(".app-calendar-weekview .current-time-line")):s=$(".app-calendar-dayview .current-time-line"):s=$(".app-calendar-weekview .current-time-line, .app-calendar-dayview .current-time-line"),b=nt/864e5,f=k*b,i=="find"?o():l.first().css("top")!=f+"px"&&n.callInAnimationFrame(function(){h!=""&&(a.removeClass("time-hidden"),p<w?a.filter('span[data-cal-hour="'+u.getHours()+'"]').addClass("time-hidden"):p>60-w&&a.filter('span[data-cal-hour="'+(u.getHours()+1)+'"]').addClass("time-hidden"),l.text(h));l.css("top",f);s.css("top",f).data("date",u);r&&r(f)}),f}}function e(n,t,r){if(!n)return"";var u=n.getHours(),f=n.getMinutes(),h=n.getSeconds(),o=i.PMDesignator,s=i.AMDesignator,e=u<12?r?"":s:r?o.substring(0,1):o;return u>12&&(s||o)&&(u=u-12),t&&u<10&&u!=0&&(u="0"+u),u==0&&(u=o||s?12:0),f<10&&(f="0"+f),!r&&e&&(e=" "+e),r&&f=="00"?String.format("{0}{1}",u,e):String.format("{0}:{1}{2}",u,f,e)}function wt(n,t,i){i<.125?n.setHours(t):i<.375?n.setHours(t,15):i<.625?n.setHours(t,30):i<.875?n.setHours(t,45):n.setHours(t,60)}function w(n){return n.getDate()==y.getDate()&&n.getMonth()==nr&&n.getFullYear()==gi}function bt(n,t){return n.getDate()==t.getDate()&&n.getMonth()==t.getMonth()&&n.getFullYear()==t.getFullYear()}function b(n){var t;return n.each(function(){return t=$(this),firstLeft=t.position().left,firstLeft>0||firstLeft*-1<t.width()/2?!1:void 0}),t}function it(n,t,i,r,u){var f=n.combinedFilter().filter(function(n){return!n.startsWith(t.Name)}),e=n.convertFieldValueToString(t,r),o=u&&n.convertFieldValueToString(t,u),s;return(s=r==null?String.format("{0}:<{1}",t.Name,o):u==null?String.format("{0}:>={1}",t.Name,e):String.format("{0}:$between${1}$and${2}",t.Name,e,o),r&&isNaN(r.getTime())||u&&isNaN(u.getTime()))?(console&&console.log&&console.log("Error forming date filter: Date is NaN"),f):(f.push(s),f)}function t(n){var r=n.attr("data-cal-year"),t=n.attr("data-cal-month"),i=n.attr("data-cal-day");return new Date(r,t?t:0,i?i:1)}function wi(n,t,i){var o="",r=new Date(n,t,1),s=f[r.getDay()],h=new Date(n,t+1,1),l=f[h.getDay()],u="",c=0,a=0,e;for(l!=0&&h.setDate(h.getDate()+(6-l)+1),s!=0&&r.setDate(r.getDate()-s);a<42;)if(s=f[r.getDay()],s==0&&(u&&(o+=u+"<\/tr>"),c++,u="<tr>"),u+="<td",e=r.getMonth(),e==t||i?(i&&e!=t?u+=t==11&&e==0||!(t==0&&e==11||e<t)?' class="app-next-month"':' class="app-prev-month"':g.setHours(0,0,0,0)==r.setHours(0,0,0,0)&&(u+=' class="app-current-day"'),i&&(u+=String.format(' data-cal-month="{0}" data-cal-day="{1}"',r.getMonth(),r.getDate())),u+=String.format(">{0}",r.getDate())):u+=">&nbsp;",u+="<\/td>",r.setDate(r.getDate()+1),a++,!i&&r>=h)break;for(o+=u;c<6;)c++,o+="<tr><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><\/tr>";return o+""}function l(n,t){ei.activePage.find(".app-tabs .ui-btn").each(function(){var n=$(this);if(n.attr("data-text")==t.text())return n.trigger("vclick"),!1})}function k(n,t){var r=n.find(".app-tabs a"),i;return r.each(function(){var n=$(this);if(n.attr("data-text")==t)return i=n,!1}),i}function sr(n){var o=n.get_hasParent(),s=n.get_filterFields(),e=[],t=[],i,r,u,f;return $(n._allFields).each(function(){var n=this,c;if(n.Tag)for(match=oi.exec(n.Tag);match!=null;){var a=match[1]?parseInt(match[1]):0,l=match[2],v=match[4],h=t[a];if(l=="disabled")break;h||(t[a]=h={});switch(l){case"date":h.date=n;break;default:h[l]=!v?n:v}match=oi.exec(n.Tag)}if((n.ItemsDataController||n.AliasName)&&n.ItemsStyle!="CheckBoxList"&&(o&&n.Name==s||(r?u||(u=n):r=n)),i||n.Type!="String"||(i=n),(n.Type=="DateTime"||n.Type=="Date")&&!n.tagged("calendar-disabled")){for(f||(f=n),c=0;e[c];)c++;e[c]={date:n,name:n.Label}}}),$.isEmptyObject(t)&&(t=e),$(t).each(function(){var t=this,e;!t.text&&i&&(t.text=i);!t.date&&f&&(t.date=f);t.name||(t.name=t.date.Label);r&&!t.color&&(t.color=i&&u&&i==r?u:r);e=t.color?n.viewProp("calendarColorMap-"+t.color.Name):null;t.colorMap=new fi(n,t,e)}),t}function bi(t,i,r){var u=t.originalEvent,f=i.find(r.mode=="week"?".app-calendar-week-grid":".app-calendar-day-grid"),e=f.find(".current-time-line");return u.pageY!=null?u.pageY-i.offset().top+i.scrollTop()-(f.offset().top+i.scrollTop()-i.offset().top)-n.toPixels(e.css("margin-top")):u.layerY-22}function d(t,i){var u=n.dataView(),r=u&&u.calendar,c=u&&u.extension().viewStyle;t||(t=r.scrollable());var f=t.find('.app-presenter[data-presenter="calendar"]'),e=f.data("cal-header"),s=f.data("cal-footer"),h=r.viewClassName(),o=f.find(h);i&&(r.preventNavigate=!0,r.getViewHandler().resize(o,e,s,!0));ut&&ut();r.updateHeader(e);r.loadData(o);u.calendarPlugin.refresh()}function ki(n,t){return(t-n)/36e5*(c/25)}function di(t){if(t.calendar)return!0;if(t._keyFields.length>1)return!1;var i=[],r=n.sidebar(),i=sr(t);return $.isEmptyObject(i)?!1:(t.calendar=new dt(t,i),t.calendarPlugin||(t.calendarPlugin=new ui(t,i)),!0)}function hr(t){t||(t=n.sidebar());t.find(".app-calendar-plugin").addClass("app-hide-request")}for(var kt,dt,gt,ni,ti,ii,ri,ui,fi,cr=$(window),ei=$.mobile,n=$app.touch,s=Web.DataViewResources,ct=s.Pager,h=s.HeaderFilter,u=s.Presenters.Calendar,lt=s.Mobile,i=Sys.CultureInfo.CurrentCulture.dateTimeFormat,y=new Date,g=new Date(y.getFullYear(),y.getMonth(),y.getDate()),gi=y.getFullYear(),nr=y.getMonth(),oi=/calendar(\d+)?-([a-zA-Z]+)(:['"]?([a-zA-Z]+)['"]?)?(\d+)?/g,tr=/^(\d+), (\d+), (\d+)(, (.*))?$/,rt,si,ut,at,ft,et,hi,ci,li,ai,vi,yi,ot=500,st=100,nt=66,vt=0,c=1060,a={year:2,month:2,week:7,day:1,agenda:1},yt={year:5,month:5,week:21,day:2,agenda:90},ir=30,pt=30,rr=23,pi=5,f=[],tt=[],p,r,ur='<a class="ui-btn app-has-droparrow app-month-picker">{0}<\/a> <a class="ui-btn app-has-droparrow app-year-picker">{1}<\/a>',fr='+{0} <span class="app-month-more">'+lt.More.toLowerCase()+"<\/span>",v=0;v<7;v++)f[v]=(7+v-i.FirstDayOfWeek)%7,tt[v]=(v+i.FirstDayOfWeek)%7;kt=function(n){this.calendar=n;this.data={day:{},month:{},year:{},agenda:{}}};kt.prototype={select:function(n){var t=this.calendar.mode,u=new Date(n),i,r;if(t=="week")t="day";else if(t=="agenda")return this.data[t][n];return(r=this.data[t][u.getFullYear()],!r)?null:t=="year"?r:(i=r[u.getMonth()],!i)?null:t=="month"?i:i[u.getDate()]},insert:function(n,t){var a=new Date(n),y=this.dataView,p=this.calendar.activeCalendar.date,i=this.calendar.mode,l=i=="week"?7:1,f,c,h,o,e,r,u,s;if(i=="week")i="day";else if(i=="agenda"){n<0&&t.reverse();this.data[i][n]=t;return}switch(i){case"year":this.data[i][n.getFullYear()]={};break;case"month":r=this.data[i][n.getFullYear()];r||(r=this.data[i][n.getFullYear()]={});r[n.getMonth()]={};break;case"day":for(f=new Date(n),v=0;v<l;v++)r=this.data[i][f.getFullYear()],r||(r=this.data[i][f.getFullYear()]={}),u=r[f.getMonth()],u||(u=r[f.getMonth()]={}),u[f.getDate()]={rows:[],count:0},f.setDate(f.getDate()+1)}for(c in t)(h=t[c],o=tr.exec(h[0]),o)&&(e=new Date(o[1],parseInt(o[2])-1,o[3]||o[2]),r=this.data[i][e.getFullYear()],r||(r=this.data[i][e.getFullYear()]={}),u=r[e.getMonth()],u||(u=r[e.getMonth()]={}),s=u[e.getDate()],s||(s=u[e.getDate()]={rows:[],count:0}),i=="year"?s.count=h[1]:($(h[1]).each(function(){this.length==5&&s.rows.push(this)}),s.count+=h[2]))},clear:function(){this.data={day:{},month:{},year:{},agenda:{}}},clearAgenda:function(){this.data.agenda={}}};$(document).on("scrollstart.app",function(){rt=!0}).on("scroll.app scrollstop.app resized.app",function(t){var f;rt=!1;var i=n.dataView(),r=i&&i.calendar,s=i&&i.extension().viewStyle(),u=t.type=="resized";if(i&&s=="calendar"&&r){if(f=r.mode.match(/day|week/),u&&f){var h=r.scrollable(),c=h.find('div[data-presenter="calendar"]'),e=c.data("cal-header"),o=r.getVisibleView();o&&o.removeClass("app-has-current-day");e&&e.find(".app-week-header ul, .app-day-header ul").css("visibility","hidden")}clearTimeout(si);si=setTimeout(function(){rt||!u&&f||d(t.relatedTarget,u)},300)}}).on("swipeleft",".app-calendar-dayview, .app-day-header, .app-calendar-weekview, .app-week-header",function(t){t.preventDefault();p=!0;clearTimeout(et);et=setTimeout(function(){var i=n.dataView(),t=i.calendar;t&&t.scrollView("next")},st)}).on("swiperight",".app-calendar-dayview, .app-day-header, .app-calendar-weekview, .app-week-header",function(t){t.preventDefault();p=!0;clearTimeout(et);et=setTimeout(function(){var i=n.dataView(),t=i.calendar;t&&t.scrollView("prev")},st)}).on("wheel",".app-calendar-dayview, .app-day-header, .app-calendar-weekview, .app-week-header",function(){return}).on("more.app",function(t){var p=$(t.target),f=p.closest(".app-echo"),r=f.length?$app.find(f.attr("data-for")):n.dataView(),e=$.mobile.activePage.find(".app-wrapper"),o=e.find(".app-calendar"),w=t.type=="more",b=t.type=="viewselector",s;if(r&&o.length&&o.is(":visible")&&(s=r.extension().viewStyle(),s=="calendar")){var k=r.viewProp("calendarConfig"),i=k.mode,d=e.parent().find(".app-bar-calendar .app-tabs"),h={text:u.Day,icon:i=="day"?"check":!1,callback:l},c={text:u.Week,icon:i=="week"?"check":!1,callback:l},a={text:u.Month,icon:i=="month"?"check":!1,callback:l},v={text:u.Year,icon:i=="year"?"check":!1,callback:l},y={text:u.Agenda,icon:i=="agenda"?"check":!1,callback:l};w&&t.panel[0].id=="app-panel-view-options"?t.items.splice(t.items.length,0,{},h,c,a,v,y):b&&d.css("visibility")=="hidden"&&t.items.splice(0,0,h,c,a,v,y,{})}}).on("dragstart",".app-calendar",function(t){var u=t.originalEvent.dataTransfer,f=$(t.target),o=f.closest(".app-echo"),c=o.length?$app.find(o.attr("data-for")):n.dataView(),s=c.calendar,l=t.originalEvent.pageY-f.offset().top,h;u.effectAllowed="move";var f=$(t.target),i=f.closest(".app-event"),a=f.is(".app-event-handle"),e=i.data("data-context");if(e&&(p=!0,r={element:i,context:e,offset:l,mode:"move"},s.mode.match(/day|week/))){var v=i.closest(".app-calendar-day"),y=v.width()-(s.mode=="day"?150:10)-3,w=n.desktop()&&navigator.userAgent.indexOf("Safari")!=-1&&navigator.userAgent.indexOf("Chrome")==-1;r.preview=i.clone().addClass("app-event-preview");a?(r.mode="resize",r.offset=0):r.preview.css({width:y,marginLeft:"0px"});u.setDragImage?(u.setData("text/plain","DAF:"+e[0]),h=w?t.closest(".app-calendar-day")[0]:$("<img>")[0],u.setDragImage(h,0,0),setTimeout(function(){i.css("visibility","hidden")})):i.css("display","none")}n.stickyHeaderBar().hide().addClass("app-disabled")}).on("dragend",".app-calendar",function(t){if(r){var u=$(t.target),i=u.closest(".app-echo"),f=i.length?$app.find(i.attr("data-for")):n.dataView(),e=f.calendar;$(".app-calendar").removeClass("app-has-time-prompt");setTimeout(o,st*2);r.dropped||(r.element.css({visibility:"",display:""}),r.preview&&r.preview.remove());r.preview&&r.preview.length&&(r.preview=null);r=null;n.stickyHeaderBar().removeClass("app-disabled");e.preventNavigate=!0}}).on("dragover",".app-calendar",function(i){var y,ut,ot,tt;if(r){var k=$(i.target),it=k.closest(".app-echo"),d=it.length?$app.find(it.attr("data-for")):n.dataView(),h=d&&d.calendar,g=!1,l,ht,f,a;if(d&&h){f=h.scrollable();ht=r.context[1];a=r.preview;switch(h.mode){case"day":case"week":if(l=k.closest(".app-calendar-day,.current-time-line"),l.length){g=!0;var ct=i.originalEvent,u=l.is(".current-time-line")?l.data("date"):t(l),lt=bi(i,f,h)-r.offset,vt=c/25,v=lt/vt,nt=ct.pageY-f.position().top,rt=f.height()-nt;if(r.mode!="resize"||r.appended||(r.appended=!0,r.preview.appendTo(l.find("ul.app-calendar-eventlist"))),at||(at=setTimeout(function(){n.desktop()&&navigator.userAgent.indexOf("Chrome")==-1&&(nt<20?n.scroll(f,f.scrollTop()-(20-nt)):rt<20&&n.scroll(f,f.scrollTop()+(20-rt)));at=null},20)),v>23.75?v=23.75:v<0&&(v=0),y=Math.floor(v),ut=v-y,y!=null&&(wt(u,y,ut),!r.previewDate||u.getTime()!=r.previewDate.getTime())){var yt=h.mode=="week"?"week":"find",pt=o(u,yt)+22,bt=h.getVisibleView(f),ft=h.getBlockByDate(bt,u);if(ft.length){var s=r.context[1],et=r.context[2],p=new Date(s),w,b;p.setMinutes(p.getMinutes()+30);r.mode=="resize"?(u.setFullYear(s.getFullYear(),s.getMonth(),s.getDate()),u<p&&(u=p),w=e(s,!1)+" - "+e(u,!1),b=e(s,!1)+" - "+e(u,!1),a.css("height",ki(s.getTime(),u.getTime()))):(w=e(u,!1,!0),b=e(u),et&&(ot=et.getTime()-s.getTime(),tt=new Date(u.getTime()+ot),w+=" - "+e(tt,!1),b+=" - "+e(tt,!1)),a.css("top",pt),a.appendTo(ft.find(".app-calendar-eventlist")));a.find(".app-event-time").text(w);a.find(".app-event-time-long").text(b);r.previewDate=u}}}break;case"month":var st=k.closest("td"),dt=st.closest(".app-calendar-month"),kt=st.attr("data-cal-day");g=!!kt;break;case"year":case"agenda":return}g&&(i.originalEvent.dataTransfer.dropEffect="move",i.preventDefault())}}}).on("drop",".app-calendar",function(i){var l,b,it,a,k,v,d,rt;if(r){var g=$(i.target),nt=g.closest(".app-echo"),e=nt.length?$app.find(nt.attr("data-for")):n.dataView(),o=e&&e.calendar,y;if(e&&o&&e._keyFields.length){y=o.scrollable();var tt=o&&o.activeCalendar,p=r.context,f=p[1],u,w=p[2],s;switch(o.mode){case"day":case"week":if(l=g.closest(".app-calendar-day,.current-time-line"),l.length){u=l.is(".current-time-line")?l.data("date"):t(l);var et=i.originalEvent,ut=bi(i,y,o)-r.offset,ft=c/25,h=ut/ft;h>23.75?h=23.75:h<0&&(h=0);b=Math.floor(h);it=h-b;wt(u,b,it);r.mode=="resize"&&(u.setFullYear(f.getFullYear(),f.getMonth(),f.getDate()),s=u,u=f,a=new Date(f),a.setMinutes(a.getMinutes()+30),s<a&&(s=a))}break;case"month":k=$(i.target).closest("td");v=k.closest(".app-calendar-month");v.length&&(u=new Date(f),u.setYear(v.attr("data-cal-year")),u.setMonth(v.attr("data-cal-month")),u.setDate(k.attr("data-cal-day")),u.getDate()==f.getDate()&&u.getMonth()==f.getMonth()&&(u=null));break;case"year":case"agenda":return}u&&(d=[{field:e._keyFields[0].Name,value:p[0]},{field:tt.date.Name,oldValue:f,newValue:u}],(w||s)&&(s||(rt=w.getTime()-f.getTime(),s=new Date(u.getTime()+rt)),d.push({field:tt.end.Name,oldValue:w,newValue:s})),i.preventDefault(),i.stopPropagation(),r.dropped=!0,$app.execute({command:"Update",controller:e._controller,view:e._viewId,values:d,success:function(){o.lastScrollTop=y.scrollTop();e.sync()},error:function(n){$app.alert(String.format("{0}",n.get_message()))}}))}}}).on("vclick contextmenu taphold",".app-calendar, .app-bar-calendar",function(f){var ui,nr,ni,st,vi,y,ht,tt,rt,nt,ut,ki,ct;if(p||r){p=!1;return}var e=$(f.target),hi=f.type,kt=e.closest(".app-echo"),lt=kt.length?$app.find(kt.attr("data-for")):n.dataView(),s=lt.calendar,b=$.mobile.activePage.find(".app-wrapper"),et=b.find('.app-presenter[data-presenter="calendar"]'),v=e.closest(".ui-btn"),dt=e.parent(),ri=e.attr("data-cal-hour"),di,hr=n.lastTouch();if(lt&&lt.calendar&&(di=lt._lookupInfo,!(e.closest(".app-tabs ul").length>0))){if(v.length||(v=e.find(".ui-btn")),e.is("ul")&&!!dt.attr("data-cal-day"))e=dt;else if(dt.is(".app-event"))e=dt;else if(e.is(".app-tabs")){return!1;var ci,gi}if((hi!="taphold"||e.is(".app-event"))&&(hi!="contextmenu"||e.is("td,.app-event")||ri!=null)){if(ui=e.data("data-context"),nr=e.data("data-more-context"),e.is(".dv-load-at-top, .dv-load-at-bottom, .app-btn-next, .app-btn-prev")){var it=s.getBlocks(b),d,rt,gt=kt.length?0:yt[s.mode],w=s.views[s.mode];if(e.is(".dv-load-at-top, .app-btn-prev")){it.length>gt&&(s.mode=="agenda"?w.removeData(b.find(".app-calendar-agendaview"),w.maxPage):it.slice(gt).remove());var ot=it.first(),g,fi=0,rt=Number(ot.data("cal-year")),ut=ot.data("cal-month")!=null?Number(ot.data("cal-month")):1,d=t(ot),tr=b.scrollTop(),li=e.outerHeight(!0)-b.find(".app-presenter-instruction").outerHeight(!0),ai=[];for(st=0;st<a[s.mode];st++){switch(s.mode){case"month":d.setMonth(d.getMonth()-1);g=w.drawMonth(d);break;case"year":d.setFullYear(rt-1);rt=d.getFullYear();g=w.drawYear(d);li+=-6;break;case"agenda":e.text(h.Loading);w.loadData(b.find(".app-calendar-agendaview"),null,w.minPage-1)}g&&(g.insertBefore(ot),ot=g,ai.push(g))}w.resize(s.getVisibleView());$(ai).each(function(){fi+=$(this).outerHeight(!0)});fi&&n.scroll(b,Math.ceil(tr+fi+li))}else{var at=it.last(),g,rt=Number(at.data("cal-year")),ut=at.data("cal-month")!=null?Number(at.data("cal-month")):1,d=new Date(rt,ut);for(it.length>gt&&(s.mode=="agenda"?w.removeData(b.find(".app-calendar-agendaview"),w.minPage):(it.slice(0,it.length-gt).remove(),ni=0,it.each(function(){ni+=$(this).height()}),n.scroll(b,ni-1))),st=0;st<a[s.mode];st++){switch(s.mode){case"month":d.setMonth(d.getMonth()+1);g=w.drawMonth(d);break;case"year":d.setFullYear(rt+1);rt=d.getFullYear();g=w.drawYear(d);break;case"agenda":e.text(h.Loading);w.loadData(b.find(".app-calendar-agendaview"),null,w.maxPage+1)}g&&(g.insertAfter(at),at=g)}w.resize(s.getVisibleView())}return!1}if(ui)return s.selectEvent(ui,e,f),f.preventDefault(),!1;if(e.is(".app-event-more")){if(!s.hasKeyFields())return!1;y=t(e.closest(".app-calendar-day"));vi=e.data("data-more-context");s.showEventList(y,vi,e,f)}else if(e.closest(".app-calendar-month-more").length){if(!s.hasKeyFields())return!1;var yi=e.closest(".app-calendar-month-more"),vt=e.closest("td"),ir=vt.find(".app-event"),pi=[],ut=e.closest(".app-calendar-month"),nt=vt.attr("data-cal-day"),ei=t(ut);ei.setDate(nt);ir.each(function(){var n=$(this),t=n.data("data-context");pi.push(t[0])});function wi(n){n=n.filter(function(n){return pi.indexOf(n[0])==-1});s.showEventList(ei,n,e,f)}yi.addClass("ui-btn-active");n.callWithFeedback(vt,function(){yi.removeClass("ui-btn-active");var n=vt.data("data-more-context");n?wi(n):s.requestData({mode:"daylist",date:ei,success:function(t){t.Pivots.pivot0&&t.Pivots.pivot0.Data[1]&&(n=t.Pivots.pivot0.Data[1][1],vt.data("data-more-context",n),wi(n))}})})}else{if(e.closest(".app-day-header").length){if(e.is("ul"))return;var oi=et.find(".app-calendar-dayview"),ht=v.closest(".app-day-header"),rr=et.data("cal-footer");return n.callWithFeedback(v,function(){var f=et.data("cal-footer").find(".app-scroll-outer"),r=v.closest("li"),n=t(r),e=n.getFullYear(),o=n.getMonth(),h=n.getDate(),i=s.getBlockByDate(oi,n,"day"),u=parseInt(oi.css("marginLeft"),10)-i.position().left;i.length&&s.views.day._scroll(oi,ht,u*-1,rr,!0)}),!1}if(e.closest(".app-week-header").length)return e.is("ul")?void 0:(n.callWithFeedback(v,function(){var n=k(e.closest(".app-bar-calendar"),u.Day),i=t(v.closest("li"));s.navigateDate=i;n&&n.trigger("vclick")}),!1);if(e.is(".ui-btn")||e.closest(".ui-btn").length){if(v.is(".app-calendar-today,.app-calendar-next,.app-calendar-prev"))return n.callWithFeedback(v,function(){if(b.length>0){var t=v.is(".app-calendar-next"),i=v.is(".app-calendar-prev"),n="today";t?n="next":i&&(n="prev");s.scrollView(n)}}),!1;if(v.is(".app-calendar-badge")){var ti=lt.viewProp("calendarConfig"),pt=ti.mode,ur=b.parent().find(".app-bar-calendar .app-tabs");ur.css("visibility")=="hidden"?n.callWithFeedback(v,function(){n.listPopup({anchor:v,iconPos:"left",items:[{text:u.Day,icon:pt=="day"?"check":!1,callback:l},{text:u.Week,icon:pt=="week"?"check":!1,callback:l},{text:u.Month,icon:pt=="month"?"check":!1,callback:l},{text:u.Year,icon:pt=="year"?"check":!1,callback:l},{text:u.Agenda,icon:pt=="agenda"?"check":!1,callback:l}]})}):n.callWithFeedback(v,function(){n.listPopup({anchor:v,title:v.attr("title")})})}else if(v.is(".app-calendar-month-header")){ht=et.data("cal-header");tt=k(ht,u.Month);switch(s.mode){case"year":rt=e.closest(".app-calendar-year").attr("data-cal-year");ut=e.closest(".app-calendar-month").attr("data-cal-month");y=new Date(rt,ut);break;case"agenda":y=t(v)}if(y)return s.navigateDate=y,n.callWithFeedback(v,function(){tt&&tt.trigger("vclick")}),!1}else if(v.parent().attr("data-cal-day")||e.is("h2")){if(s.mode=="month"){var ut=e.closest(".app-calendar-month"),ht=et.data("cal-header"),tt=k(ht,u.Day),y=t(ut);return e.is("td")?void 0:(y.setDate(v.parent().attr("data-cal-day")),s.navigateDate=y,n.callWithFeedback(v,function(){tt&&tt.trigger("vclick")}),!1)}if(s.mode=="agenda"&&!kt.length){var y=t(e.closest("li")),ht=et.data("cal-header"),tt=k(ht,u.Day);y&&(s.navigateDate=y,n.callWithFeedback(v,function(){tt&&tt.trigger("vclick")}))}}}else if(e.is("td")||e.is("div")&&ri!=null){if(s.mode=="year"){if(e.height()<20&&!er())e.closest(".app-calendar-month").find(".app-calendar-month-header").trigger("vclick");else{if(nt=parseInt(e.text()),!nt)return;var rt=e.closest(".app-calendar-year").attr("data-cal-year"),ut=e.closest(".app-calendar-month").attr("data-cal-month"),ht=et.data("cal-header"),tt=k(ht,u.Day),y=new Date(rt,ut,nt);s.navigateDate=y;e.addClass("ui-btn-active");n.callWithFeedback(e,function(){tt&&tt.trigger("vclick");e.removeClass("ui-btn-active")})}return!1}var si=s.getActionsByName("New"),y,ft,cr=$(".app-calendar"),ti=s.activeCalendar,ii=!!ti.end,bi=s.mode=="month",bt;if(!si.length)return;if(bi){if(nt=e.attr("data-cal-day"),ut=e.closest("div.app-calendar-month"),!nt)return;y=t(ut);y.setDate(nt);ii&&(ft=new Date(y),ft.setMinutes(ft.getMinutes()+60))}else{var nt=e.closest("div.app-calendar-day"),fr=nt.find(".app-calendar-eventlist"),or=f.clientY-e.offset().top,ni=e.height(),sr=or/ni;y=t(nt);wt(y,ri,sr);ii&&(ft=new Date(y),ft.setMinutes(ft.getMinutes()+60));bt=s.drawEvent([null,y,ft,null," "],null).removeClass("app-event-color-0").addClass("app-event-new");ii&&bt.height(c/25);ki=o(y,"find");bt.css("top",ki+22).appendTo(fr)}return y?(si.forEach(function(n){var t=n.callback;n.callback=function(n){$app.newValues=[{name:ti.date.Name,value:y}];ii&&$app.newValues.push({name:ti.end.Name,value:ft});t(n)}}),ct={iconPos:"left",items:si,title:String.format("{0:"+i.LongDatePattern+"} {0:"+i.ShortTimePattern+"}",y),afterclose:function(){bt&&bt.remove()}},bi?ct.anchor=e:(ct.x=f.pageX,ct.y=f.pageY,ct.arrow="b,t,l,r"),n.listPopup(ct),!1):void 0}}}}}).on("clear.dataview.app",function(n){var t=n.dataView,i=t.calendar;i&&$("#"+t._id).find(".app-calendar-selected").removeClass("app-calendar-selected")}).on("reset.dataview.app",function(t){var i=t.dataView,f,e;if(i){var r=i.calendar,o=i&&i.extension()&&i.extension().viewStyle(),u=i.calendarPlugin;if(r&&(r.clear(),r.activeCalendar.colorMap.clearFilter()),u){if(f=i&&i.get_viewType(i._id),e=i.get_master(),e&&!i.get_selectedKey().length)return;f&&f=="Grid"&&(u.filtering||(u.clearCache(),n.stickyHeaderBar().hide()))}}}).on("show.dataview.app",function(t){var i=t.dataView,r=i&&i.get_viewType(i._id),u=n.sidebar();if(!i||r!="Grid"){hr(u);return}if(di(i))r&&r=="Grid"&&(i.calendar&&i.calendar.loadData(i.calendar.getVisibleView()),i.calendarPlugin&&i.calendarPlugin.attach(u));else return});dt=function(n,t){var i=this,r;i.dataView=n;r=n.viewProp("calendarConfig")||{};r.mode||(r.mode=$(document).width()<768?"day":"week");i.mode=r.mode;i.calendars=t;r.activeCalendar&&$(t).each(function(){if(this.name==r.activeCalendar)return i.activeCalendar=this,!1});i.activeCalendar||(i.activeCalendar=t[Object.keys(t)[0]]);i.cache=new kt(i);i.views={day:new gt(i),week:new ni(i),month:new ti(i),year:new ii(i),agenda:new ri(i)};n.viewProp("calendarConfig",r)};dt.prototype={scrollable:function(){var t=this,n=t._scrollable;return n||(n=t._scrollable=$("#"+this.dataView._id+" .app-wrapper")),n},viewClassName:function(){return String.format(".app-calendar-{0}view",this.mode)},show:function(i){var r=this,s=this.dataView,ut=s._filter,h=i.container.closest(".app-echo").length>0,c=i.container.find(".app-calendar"),v=i.container.closest(".app-wrapper"),ft=i.container.data("pivots"),k=this.calendars,y=s.viewProp("calendarConfig"),d=this.activeCalendar.colorMap,f,g,o,l,p,w,e,b,a,nt;if(!$.isEmptyObject(k)){if(!h&&this.lastScrollTop&&v.scrollTop()==0&&n.scroll(v,this.lastScrollTop),h?(this.mode="agenda",this.echoMaxHeight=i.maxHeight,y.mode="agenda",s.viewProp("calendarConfig",y)):y.mode&&(this.mode=y.mode),p=this.getViewHandler(),this.navigateDate||this.preventNavigate||(w=s.extension().commandRow(),w&&this.activeCalendar.date?(this.enhancePrecision=!0,this.navigateDate=w[this.activeCalendar.date.Index]):this.navigateDate=new Date),c.length>0){if(e=i.container.find(".app-calendar > div:visible"),!h)if(f=i.container.data("cal-header"),o=i.container.data("cal-footer"),p.showHeaderAndFooter(f,o),$app.touch.bar("show",f),d.show(),e.is(r.viewClassName())){if(this.navigateDate&&!this.preventNavigate){if(l=this.getBlockByDate(e,this.navigateDate),l&&l.length&&!h){this.scroll({view:e,enhancePrecision:!0});return}this.animate=!1}}else e.hide()}else if(c=$('<div class="app-calendar"><\/div>').appendTo(i.container),!h){f=$('<div class="app-bar-calendar"><\/div>').appendTo($app.touch.bar("create",{type:"header",page:i.container}));g=$('<div class="app-calendar-badge ui-btn"><\/div>').appendTo(f);$app.touch.tabs("create",{container:$('<div class="app-tabs"><\/div>').appendTo(f),tabs:[{text:u.Day,value:"day",selected:this.mode=="day"},{text:u.Week,value:"week",selected:this.mode=="week"},{text:u.Month,value:"month",selected:this.mode=="month"},{text:u.Year,value:"year",selected:this.mode=="year"},{text:u.Agenda,value:"agenda",selected:this.mode=="agenda"}],change:function(u){var e=r.mode,h=r.getMostVisibleBlock(v,e),f=h&&t(h),o=!1,c=s.viewProp("calendarConfig"),l=s.calendarPlugin;if(c.mode=u.value,s.viewProp("calendarConfig",c),!r.navigateDate){if(r.lastDate)switch(e){case"year":r.lastDate.getFullYear()==f.getFullYear()&&(o=!0);break;case"month":r.lastDate.getFullYear()==f.getFullYear()&&r.lastDate.getMonth()==f.getMonth()&&(o=!0)}r.navigateDate=o?r.lastDate:f;r.enhancePrecision=!0}e.match(/week|day/)&&(r.lastDayScrollTop=v.scrollTop());i.container=i.container.closest(".app-wrapper");i.container.focus();r.navigateDate&&isNaN(r.navigateDate.getTime())&&(alert("navigate date is NaN"),r.navigateDate=new Date);n.presenter("show",i);l&&l.refresh()},restoreScrolling:!1,stickyHeader:!0});i.container.data("cal-header",f);$('<a class="ui-btn ui-btn-icon-notext ui-icon-carat-l ui-corner-all app-calendar-prev"><\/a>').attr("title",ct.Previous).appendTo(f);$('<a class="ui-btn ui-btn-icon-notext ui-icon-carat-r ui-corner-all app-calendar-next"><\/a>').attr("title",ct.Next).appendTo(f);b=$('<a class="ui-btn ui-btn-icon-notext ui-icon-calendar ui-corner-all app-calendar-today"><\/a>').attr("title",u.Today);b.appendTo(f);o=$('<div class="app-bar-calendar-footer"> <\/div>').appendTo($app.touch.bar("create",{type:"footer",page:i.container}));a=$('<div class="app-scroll-outer"><\/div>').insertBefore(o.contents().first());nt=$('<div class="app-scroll-inner"><\/div>').appendTo(a);a.on("scroll",function(){var n;if(a.data("resizing")){a.removeData("resizing");return}if(n=r.mode,n.match(/day|week/)){var t=a.scrollLeft(),i=r.viewClassName(),u=".app-"+n+"-header";r.views[n]._scroll(v.find(i),f.find(u),t,o)}});this.mode.match(/day|week/)&&$app.touch.bar("show",o);i.container.data("cal-footer",o);or()}this.activeCalendar.end?c.addClass("app-calendar-has-end-time"):c.removeClass("app-calendar-has-end-time");var tt=String.format("app-calendar-{0}view",this.mode),it=String.format(".app-{0}-header",this.mode),e=c.find("."+tt),rt=h?null:f.find(it);this.navigateDate&&!this.preventNavigate&&(l=this.getBlockByDate(e,this.navigateDate));e.length>0&&(this.preventNavigate||this.navigateDate&&l&&l.length)?(e.is(":visible")||e.fadeIn(),p.resize(e,rt,o)):e=p.draw(c,this.navigateDate);h||($app.touch.bar("show",f),r.updateHeader(f));this.resetVars()}},scroll:function(n){n.view||(n.view=this.getVisibleView());n.preventNavigate==null&&(n.preventNavigate=this.preventNavigate);n.enhancePrecision==null&&(n.enhancePrecision=this.enhancePrecision);n.animate==null&&(n.animate=this.animate);n.date==null&&(n.date=this.navigateDate);this.getViewHandler().scroll(n);this.resetVars()},hide:function(t){var r=n.dataView(),e=r&&r.extension().viewStyle(),i=this.scrollable();if(i&&(this.lastScrollTop=i.scrollTop()),e!="calendar"){var u=t.container.data("cal-header"),f=t.container.data("cal-footer"),o=n.sidebar(),s=o.find(".app-calendar-color-legend"),i=this.scrollable(),h=i.find('.app-presenter[data-presenter="calendar"]');u&&$app.touch.bar("hide",u);f&&$app.touch.bar("hide",f);this.dataView.calendarPlugin.refresh();this.activeCalendar.colorMap.hide()}},dispose:function(n){var i=n.container.data("cal-header"),t=this.dataView,r,u;!i||(i.off(),$app.touch.tabs("destroy",{container:i}),$app.touch.bar("remove",i));r=n.container.data("cal-footer");r&&(r.off(),$app.touch.bar("remove",r));n.container.removeData();clearInterval(yi);this.cache.clear(n.container);t.calendar.activeCalendar.colorMap.clearFilter();for(u in this.views)this.views[u].calendar=null;t.calendar=null;t.calendarPlugin.calendar=null;t.calendarPlugin.dataView=null;t.calendarPlugin=null;this.dataView=null;this._scrollable=null},selectEvent:function(t,i,u){function k(t){var r=!1,s=i.is(".app-calendar-selected"),u=n.pageInfo(f._id);p=o=="taphold";h||(u.echoChanged=!0);p||o=="vclick"&&g?(r=!0,t&&(i.removeClass("app-calendar-selected"),f.extension().clearSelection())):o=="contextmenu"&&(n.contextScope(f._id),n.rowContext(i,{x:l,y:a}),n.contextScope(null),r=!0);n.refreshEchoToolbarWithDelay(f,e);r||(n.contextScope(f._id),n.cardPopup({anchor:i,x:l,y:a,dataView:f}),n.contextScope(null))}function d(t){function r(n){var t=n.data("data-context");if(t&&t[c.Name]==b)return n.addClass("app-calendar-selected"),!1}f.extension().tap({row:t},y?"select":"none");v.find(".app-calendar-selected").removeClass("app-calendar-selected");e.find(".app-calendar-selected").removeClass("app-calendar-selected");h?v.find(s.viewClassName()+" .app-event").each(function(){r($(this))}):i.closest(".app-event, .app-calendar-month-more").addClass("app-calendar-selected");e.length&&e.find(".app-event").each(function(){r($(this))});y||(k(!1),n.refreshEchoToolbarWithDelay(f,e))}var o=u.type,g=u.ctrlKey,l=u.pageX,a=u.pageY,v=this.scrollable(),s=this,f=s.dataView,y=f._lookupInfo,h=i.closest(".app-echo").length;if(this.hasKeyFields()){var c=this.dataView._keyFields[0],w=this.getCurrentKey(),b=this.mode!="agenda"&&!h?t[0]:t[c.Name],e=$("#"+f._id+"_echo");if(f._keyFields.length==1){if(r)return;n.clearHtmlSelection();w!=null&&b==w?k(!0):s.mode=="agenda"?d(t):$app.execute({controller:f._controller,view:f._viewId,filter:[{field:c.Name,operator:"=",value:t[0]}],sort:"",success:function(n){r||d(n[f._controller][0])},error:function(n){$app.alert(String.format("{0}",n.get_message()))}});i.addClass("ui-btn-active");n.callWithFeedback(i,function(){i.removeClass("ui-btn-active")})}}},showEventList:function(t,r,u,f){var e=this,s=e.getCurrentKey(),o=[];r.forEach(function(n){var t=n[0],i=n[1],r=n[2],c=n[3],h=n[4];o.push({text:e.getEventTitle(i,r,h,""),color:e.activeCalendar.colorMap.color(n[3]),visible:t==s?!0:!1,callback:function(){e.selectEvent(n,u,f)}})});n.listPopup({title:String.format("{0:"+i.LongDatePattern+"}",t),anchor:u,iconPos:"left",items:o})},getViews:function(){return $("#"+this.dataView._id).find('.app-wrapper .app-presenter[data-presenter="calendar"] > div.app-calendar > div')},getVisibleView:function(){return this.scrollable().find('.app-presenter[data-presenter="calendar"] > div.app-calendar > div:visible')},getViewHandler:function(){return this.views[this.mode]},resetVars:function(){this.preventNavigate=null;this.lastDate=this.navigateDate;this.navigateDate=null;this.enhancePrecision=null;this.animate=null},clear:function(n){var i=this.getViewHandler(),t=this.getVisibleView();this.cache.clear();i.clear(n);t&&t.length&&(this.loadData(t),this.dataView.calendarPlugin&&this.dataView.calendarPlugin.clearCache())},drawDayColumns:function(n,t,i){for(var u,e,o="",r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),s=0;s<t;s++)u='<div data-cal-year="'+r.getFullYear()+'" data-cal-month="'+r.getMonth()+'" data-cal-day="'+r.getDate()+'" class="app-calendar-day',w(r)&&(u+=" current-day-column"),f[r.getDay()]==6&&(u+=" endofweek"),u+='">',e="",i&&(e+=this.drawTimeColumn(n)),e+='<div data-cal-hour="0"><\/div><div data-cal-hour="0"><\/div><div data-cal-hour="1"><\/div><div data-cal-hour="2"><\/div><div data-cal-hour="3"><\/div><div data-cal-hour="4"><\/div><div data-cal-hour="5"><\/div><div data-cal-hour="6"><\/div><div data-cal-hour="7"><\/div><div data-cal-hour="8"><\/div><div data-cal-hour="9"><\/div><div data-cal-hour="10"><\/div><div data-cal-hour="11"><\/div><div data-cal-hour="12"><\/div><div data-cal-hour="13"><\/div><div data-cal-hour="14"><\/div><div data-cal-hour="15"><\/div><div data-cal-hour="16"><\/div><div data-cal-hour="17"><\/div><div data-cal-hour="18"><\/div><div data-cal-hour="19"><\/div><div data-cal-hour="20"><\/div><div data-cal-hour="21"><\/div><div data-cal-hour="22"><\/div><div data-cal-hour="23"><\/div><div data-cal-hour="0"><\/div><ul class="app-calendar-eventlist"><\/ul><div class="app-clear-fix"><\/div>',u+=e+"<\/div>",o+=u,r.setDate(r.getDate()+1);return o},drawDayHeaders:function(n,t){for(var u="",r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),e=0;e<t;e++){var o=f[r.getDay()],s=i.DayNames[r.getDay()],h=i.AbbreviatedDayNames[r.getDay()];u+='<li  data-cal-year="'+r.getFullYear()+'" data-cal-month="'+r.getMonth()+'" data-cal-day="'+r.getDate()+'" class="';o==0&&(u+=" first-day-of-week");o==6&&(u+=" last-day-of-week");u+='"><a class="ui-btn" title="'+s+'"><span class="letter-day">'+h.substring(0,1)+'<\/span><span class="abbr-day">'+h+'<\/span><span class="full-day">'+s+"<\/span>&nbsp;<div";w(r)&&(u+=' class="app-current-day"');u+=">"+r.getDate()+"<\/div><\/a><\/li>";r.setDate(r.getDate()+1)}return u},drawTimeColumn:function(){for(var r,f,e='<div class="app-calendar-time"><ul>',t,o=!!i.AMDesignator.length,n=0;n<=24;n++)o?n==12?t=u.Noon:(r=n%12,f=n<12?i.AMDesignator:i.PMDesignator,(n==0||n==24)&&(r=12,f=i.AMDesignator),t=String.format("{0} {1}",r,f)):t=n==24?0:n,e+='<li><span data-cal-hour="'+n+'">'+t+"<\/span><\/li>";return e+'<\/ul><div class="app-current-time"><\/div><\/div>'},getBlocks:function(){return this.getViewHandler().getBlocks()},getMostVisibleBlock:function(n){var t,r,i,u;n||(n=this.scrollable());r=n.height()/2;i=$(this.getBlocks(n));switch(this.mode){case"day":case"week":if(i.each(function(){var n=$(this);if(t||(t=n),n.position().left>n.width()/2)return!1;t=n}),this.mode=="week")while(t&&t.length&&t.position().left+t.width()<=nt)u=t.next(),t=u;break;case"year":case"month":case"agenda":i.each(function(){var n=$(this);return t=n,n.offset().top+n.height()>r?!1:void 0})}return t},getFirstVisibleBlock:function(t){var i,f,r,u;t||(t=this.scrollable());f=n.stickyHeaderBar().outerHeight()+t.offset().top;r=$(this.getBlocks(t));switch(this.mode){case"day":case"week":r.each(function(){var n=$(this);if(i||(i=n),n.position().left>n.width()/2)return!1;i=n});this.mode=="week"&&i&&i.position().left<0&&(u=i.next(),u.length&&(i=u));break;case"month":case"year":case"agenda":r.each(function(){var n=$(this);if(i||(i=n),n.offset().top>f)return!1;i=n})}return i},getLastVisibleBlock:function(n){var t,r=n.height()+n.position().top,u=n.width(),i=$(this.getBlocks(n));switch(this.mode){case"day":case"week":i.each(function(){var n=$(this);if(t||(t=n),n.position().left>=u)return!1;t=n});break;case"month":case"year":case"agenda":i.each(function(){var n=$(this);if(t||(t=n),n.offset().top>r)return!1;t=n})}return t},getBlockByDate:function(n,t){var i=t.getFullYear(),r=t.getMonth(),u=t.getDate();if(!n||!n.length)return null;switch(this.mode){case"year":return n.find(String.format('.app-calendar-year[data-cal-year="{0}"]',i));case"month":return n.find(String.format('.app-calendar-month[data-cal-year="{0}"][data-cal-month="{1}"]',i,r));case"week":case"day":return n.find(String.format('.app-calendar-day[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"]',i,r,u));case"agenda":return n.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"] ul',i,r,u))}},resizeScroller:function(n,t,i){var r=t.find(".app-scroll-outer"),u=parseInt(n.css("marginLeft"),10)*-1;i&&r.find(".app-scroll-inner").css("width",i);r.scrollLeft(u).data("resizing",!0)},updateHeader:function(n){var a=this,v=a.scrollable(),lt=a.mode,et=n.find(".app-tabs"),ot=et.css("visibility")!="hidden",y=a.getFirstVisibleBlock(v),c,ft;if(y){var h=n.find(".app-calendar-badge"),f=t(y),r=f.getFullYear(),w=f.getMonth(),at=f.getDay(),e=f.getDate(),o=i.MonthNames[w],s=i.AbbreviatedMonthNames[w],vt=ot?et.find("ul").offset().left-h.offset().left:n.find("a.app-calendar-today").offset().left,st=1,u=[];switch(lt){case"year":u=["<b>"+r+"<\/b>&nbsp;"];c=y.find("h1");c.is("app-in-header")||(v.find(".app-calendar-yearview .app-calendar-year h1.app-in-header").removeClass("app-in-header"),c.addClass("app-in-header"));break;case"month":u=[String.format("<b>{0}<\/b> {1}",o,r),String.format("<b>{0}<\/b> {1}",s,r),String.format("<b>{0}<\/b>",o),String.format("<b>{0}<\/b>",s)];c=y.find("h1.app-calendar-month-header");c.is("app-in-header")||(v.find(".app-calendar-monthview .app-calendar-month h1.app-calendar-month-header.app-in-header").removeClass("app-in-header"),c.addClass("app-in-header"));break;case"week":var b=a.getLastVisibleBlock(v),k=b?t(b):new Date,d=k.getFullYear(),g=k.getMonth(),l=k.getDate(),p=w==g,nt=r==d,it=i.MonthNames[g],rt=i.AbbreviatedMonthNames[g];if(!b)return;u.push(String.format("<b>{0} {1}<\/b>{2} - <b>{3}{4}<\/b>, {5}",o,e,nt?"":", "+r,p?"":it+" ",l,d),String.format("<b>{0} {1}<\/b>{2} - <b>{3}{4}<\/b>, {5}",s,e,nt?"":", "+r,p?"":rt+" ",l,d));nt?u.push(String.format("<b>{0} {1}<\/b> - {2}{3}",o,e,p?"":it+" ",l),String.format("<b>{0} {1}<\/b> - {2}{3}",s,e,p?"":rt+" ",l),String.format("<b>{0} {1}<\/b>, {2}",o,e,r),String.format("<b>{0} {1}<\/b>, {2}",s,e,r)):u.push(String.format("<b>{0} {1}<\/b>, {2} - <b>{3} {4}<\/b>",o,e,r,it,l),String.format("<b>{0} {1}<\/b>, {2} - <b>{3} {4}<\/b>",s,e,r,rt,l),String.format("<b>{0} {1}<\/b>, {2}",o,e,r),String.format("<b>{0} {1}<\/b>, {2}",s,e,r));break;case"agenda":case"day":var yt=i.DayNames[tt[at]],pt=new RegExp(yt+"(.?) ","i"),ut=String.format("{0:"+i.MonthDayPattern+"}",f),wt=new RegExp(ut,"i"),ht=String.format("{0:"+i.LongDatePattern+"}",f).replace(wt,"<b>"+ut+"<\/b>"),ct=ht.replace(pt,"");u=[ht,ct,ct.replace(i.MonthGenitiveNames[f.getMonth()],i.AbbreviatedMonthGenitiveNames[f.getMonth()])];f.getFullYear()==(new Date).getFullYear()&&u.push("<b>"+ut+"<\/b>",String.format("<b> {0:"+i.MonthDayPattern.replace(/M+/,"MMM")+"}<\/b>",f));u.push(f.toLocaleDateString())}for(u[0]&&h.html(u[0]).attr("title",u[0].replace(/<\/?b>|&nbsp;/g,""));h.outerWidth()+5>vt;){if(ft=u[st],!ft)break;h.html(ft);st++}ot?h.removeClass("app-has-droparrow"):h.addClass("app-has-droparrow")}},scrollView:function(t){var f=this.scrollable(),o=this.dataView,r=this.getVisibleView(),i,e=t=="next"?1:-1,u;i=t!="today"?this.getViewHandler().getNextDate(r,e):new Date;u=this.getBlockByDate(r,i);u.length?this.scroll({date:i,animate:!0,view:r}):(this.navigateDate=i,n.presenter("show",{id:this.dataView._id,name:"calendar",container:f}))},loadData:function(n){var t=this,f=t.dataView.extension().viewStyle();if(this.mode=="agenda"&&t.activeCalendar.colorMap.load(!0),n.is(":visible")&&this.mode!="agenda"&&f=="calendar"){var i=n.closest(".app-wrapper"),r=t.getFirstVisibleBlock(i),u=t.getLastVisibleBlock(i);r&&u&&t.loadDataInBlock(n,r,u)}},loadDataInBlock:function(n,i,r){function h(){o?u.loadDataInBlock(n,o,r):u.activeCalendar.colorMap.load(!0)}var u=this,o=i.next(":not(.current-time-line)"),s=u.mode,f,e;if(i[0]!=r[0]&&o.length||(o=null),!this.loadingData&&u.mode!="agenda")if(i.hasClass("data-loaded"))h();else{if(!u.blockIsVisible(n,i)){h();return}f=t(i);e=this.cache.select(f);e?($.isEmptyObject(e)||this.getViewHandler().addData(n,f,e),this.loadingData=!1,i.addClass("data-loaded"),h()):this.requestData({mode:s,date:f,success:function(t){u.cache.insert(f,t.Pivots.pivot0.Data.slice(1));callback=function(){if(u.blockIsVisible(n,i)){switch(s){case"day":i.find("td > ul").empty();break;case"week":i.find("td > ul").empty();break;case"month":i.find("td > ul").empty();break;case"year":i.find("td.app-has-data").removeClass("app-has-data");break;case"agenda":return}i.addClass("data-loaded");e=u.cache.select(f);$.isEmptyObject(e)||u.views[s].addData(n,f,e);h()}ut=null};rt&&!s.match(/day|week/)?ut=callback:callback()}})}},requestData:function(n){var r=this,t=r.activeCalendar,e={controller:r.dataView._controller,command:n.mode=="agenda"?"Select":"Pivot",view:r.dataView._viewId,sort:t.date.Name,tags:r.dataView.get_tags(),success:function(t){r.loadingData=!1;n.success(t)},error:function(n){r.loadingData=!1;$app.alert(String.format("{0}",n.get_message()))}};if(n.mode){var o=n.date,i=new Date(o),t=r.activeCalendar,f={},u=f[t.date.Name]=["calendar-date","pivot-val2-count","pivot-row1-year","pivot-row2-month-raw","pivot-row3-day"],s=f[t.text.Name],h=t.color?f[t.color.Name]:null,c=t.end?f[t.end.Name]=["calendar-end"]:null;s||(s=f[t.text.Name]=["calendar-text"]);t.color&&!h&&(h=f[t.color.Name]=["calendar-color"]);switch(n.mode){case"daylist":i.setDate(i.getDate()+1);u.push("pivot-val1-calendar-first100");break;case"day":i.setDate(i.getDate()+1);u.push("pivot-row4-halfhour");u.push("pivot-val1-calendar");break;case"week":i.setDate(i.getDate()+7);u.push("pivot-row3-day","pivot-row4-halfhour");u.push("pivot-val1-calendar");break;case"month":i.setMonth(i.getMonth()+1);u.push("pivot-row3-day");u.push("pivot-val1-calendar-first5");break;case"year":i.setYear(i.getFullYear()+1);u.push("pivot-row3-day")}i.setSeconds(-1);e.pivotDefinitions=f;e._filter=it(r.dataView,t.date,null,o,i)}else n.pivots&&n.date&&n.end&&(e.pivotDefinitions=n.pivots,e._filter=it(r.dataView,t.date,null,n.date,n.end));r.loadingData=!0;$app.execute(e)},blockIsVisible:function(n,t){var i;if(!n.is(":visible"))return!1;if(i=n.closest(".app-wrapper"),this.mode.match(/month|year/)){var r=i.offset().top,f=r+i.height(),u=t.offset().top,e=u+t.height(),s=u<=f&&u>=r,h=e>=r&&e<=f,c=u<=r&&e>=f;return s||h||c}if(this.mode.match(/day|week/)){var l=i.width(),o=t.position().left,a=o+t.width();return a>=0&&o<=l}return!0},hasKeyFields:function(){return this.dataView._keyFields.length>0},getCurrentKey:function(){if(!this.hasKeyFields())return null;var t=this.dataView._keyFields[0],n=this.dataView.extension().commandRow();return n?n[t.Index]:null},getEventTitle:function(n,t,i,r){var u=e(n,!0);return t&&(u+="-"+e(t,!0)),u+="\n"+(i?i:s.Data.NullValueInForms),this.activeCalendar.color&&r!=""&&(u+="\n"+(r?r:s.Data.NullValueInForms)),u},getActionsByName:function(t){var i=[],r=[];return n.navContext(i),i.forEach(function(n){n.command==t&&r.push(n)}),r},drawDayData:function(n,t,i,r){var u=this;i.rows.forEach(function(t){var i=u.drawEvent(t,r);i.appendTo(n)});this.resizeDayData(n.find("li"))},drawEvent:function(t,i){var f=this,y=t[0],o=t[1],u=t[2],c=t[3],h=t[4],l=e(o,!1,!0),a=e(o);u&&(l+="-"+e(u,!1,!0),a+=" - "+e(u));var v=String.format('<span class="app-event-time">{0}<\/span> {1} <div class="app-event-time-long">{2}<\/div>',l,h?h:s.Data.NullValueInForms,a),r=$('<li class="app-event"><\/li>').data("data-context",t),p=f.getEventTitle(o,u,h,c),w=f.activeCalendar.colorMap.className(c);return n.desktop()&&(r.addClass("app-draggable").attr("draggable","true"),f.activeCalendar.end&&(v+='<div class="app-event-handle ui-icon-dots app-draggable" draggable="true"><\/div>')),i&&i==y&&r.addClass("app-calendar-selected"),u&&r.addClass("app-event-has-end-time"),r.addClass(w),r.html(v),r.attr("title",p),r},resizeDayData:function(n){var e=[],t=[],h=c/25,o=n.first().closest(".app-calendar-day").width()-(this.mode=="day"?150:10),l=this.mode=="day"?10:4,i,u,f,r;n.each(function(){var i=$(this);if(i.is(".app-event-more")){i.remove();return}var r=i.data("data-context"),t=r[1],n=r[2];!n||n.getTime()<t.getTime()?(n=new Date(t),n.setMinutes(n.getMinutes()+ir)):n.getDate()!=t.getDate()&&(n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59));e.push({element:i,data:r,start:t.getTime(),end:n.getTime(),depth:1,width:0})});e.sort(function(n,t){return n.start!=t.start?n.start>t.start?1:-1:n.end!=t.end?n.end<t.end?1:-1:0});u=[];r=0;e.forEach(function(n){function e(){n.depth=t.length+1;n.depth>r&&(r=n.depth);t.push(n);u.push(n)}for(i=t.pop();i;)if(i.end<=n.start)i=t.pop(),i||(u.forEach(function(n){n.width=r}),r=0,u=[]);else{t.push(i);break}t.length>=l?f?(n.collapsed=!0,f.collapsedEvents.push(n.data)):(f=n,f.collapsedEvents=[n.data],e()):(f=null,e())});u.forEach(function(n){n.width=r});e.forEach(function(n){var i,r;if(n.collapsed)n.element.hide();else{var t=n.element,u=n.data[1],e=n.data[2],c=h*(u.getHours()+u.getMinutes()/60)+22,l=ki(n.start,n.end),f=o/n.width,a=o*(n.depth-1)/n.width;n.depth!=n.width&&(f*=1.3);n.collapsedEvents&&n.collapsedEvents.length>1&&(t.hide(),i="+"+n.collapsedEvents.length+" "+s.Mobile.More,t=$('<li class="app-event app-event-more ui-icon-dots"><\/li>').appendTo(t.closest("ul")).html(i).attr("title",i).data("data-more-context",n.collapsedEvents));r={top:c,"z-index":n.depth+2,marginLeft:a+"px",width:f-3+"px"};e&&(r.height=l);t.css(r)}})}};gt=function(n){this.calendar=n};gt.prototype={draw:function(n,t){var u,v;n.find(".app-calendar-dayview").remove();var i=$('<div class="app-calendar-dayview"><\/div>').appendTo(n),o=i.closest(".app-echo").length>0,s=i.closest(".app-presenter"),y=i.closest(".app-wrapper"),h=s.data("cal-header"),l=o?null:s.data("cal-footer"),c=o?1:a.day*7,p=(a.day-1)/2*7,r=new Date(t.getFullYear(),t.getMonth(),t.getDate()),e='<div class="app-calendar-day-grid"><div class="current-time-line"><div class="dot"><\/div><\/div>';return r.setDate(r.getDate()-f[r.getDay()]),h.find(".app-day-header").remove(),u=$('<div class="app-day-header"><\/div>').appendTo(h),v=$("<ul> "+this.calendar.drawDayHeaders(r,c)+" <\/ul>").appendTo(u),ht(u),e+=this.calendar.drawDayColumns(r,c,!0),e+="<\/div>",i.html(e).find(".app-calendar-day").hide(),this.resize(i,u,l),this.scroll({view:i,date:t,enhancePrecision:!0}),i},showHeaderAndFooter:function(n,t){n.find(".app-day-header").show();n.find(".app-week-header").hide();n.find(".app-month-header").hide();$app.touch.bar("show",t);this.calendar.lastDayScrollTop=this.calendar.scrollable().scrollTop()},resize:function(n,t,i){t.is(".app-day-header")||(t=t.find(".app-day-header"));var u=n.closest(".app-echo").length>0,v=n.find(".app-calendar-day-grid"),f=n.find(".app-calendar-day"),r=t.find("li"),y=this.calendar.scrollable(),e=y.outerWidth(),p=Math.floor(e/7),s=f.length*e,h=b(f),l=u?null:b(r),w=h.position().left,k=u?0:l.position().left,d=parseInt(n.css("marginLeft"),10)*-1,g=u?0:parseInt(t.css("marginLeft"),10)*-1;if(v.width(s),t.width(r.width()*r.length),r.closest("ul").css("visibility",""),r.width(p),f.width(e).fadeIn(),n.height(c),!u){var nt=h.position().left,tt=l.position().left,it=w-nt,a=Math.floor(k-tt);a!=0&&t.css("marginLeft",g*-1+a);this._scroll(n,t,d-it,i);i!=null&&this.calendar.resizeScroller(n,i,s)}o();this.resizeData(n)},scroll:function(t){var e=this,r=e.calendar,s=r.dataView.extension().commandRow(),y=r.scrollable(),u=t.view,p=t.animate,h=u.closest(".app-presenter"),w=h.data("cal-header").find(".app-day-header"),b=h.data("cal-footer"),i=t.date,c=r.getBlockByDate(u,i),l,a,f,v;c.length&&(l=parseInt(u.css("marginLeft"),10),a=c.position().left,e._scroll(u,w,a-l,b,p));t.enhancePrecision&&(s?(v=s[r.activeCalendar.date.Index],f=o(v,"find")):f=i.getHours()==0&&i.getMinutes()==0&&i.getSeconds()==0&&i.getMilliseconds()==0?r.lastDayScrollTop||o():o(i,"find"),n.scroll(y,f))},_scroll:function(i,r,u,f,e){var h;n.animate()||(e=!1);var l=parseInt(i.css("marginLeft"),10),s=u*-1,o=this,c=i.find(".app-calendar-day-grid");if(i.removeClass("app-has-current-day"),vt++,e==!0){i.animate({marginLeft:s},ot,function(){o._scroll(i,r,u,f)});return}i.css("marginLeft",s);h=this.updateDayHeader(i,r);clearTimeout(ft);ft=setTimeout(function(){var n=i.find(".app-calendar-day"),e=b(n),g=n.width(),v=u%g,y,w=a.day*7,k=yt.day*7,it,ft,et,ct,lt,p,rt,nt,tt;if(vt==1&&v!=0?(s>l?(v=v*-1,e=e.prev(),e.is(".current-time-line")&&(e=e.prev())):(v=g-v,e=e.next(),e.is(".current-time-line")&&(e=e.next())),h=o.updateDayHeader(i,r,e)):v=v>g/2?g-v:v*-1,it=s-v,ft=it*-1,u<g)p=n.first(),rt=p.position().left,y=t(p),y.setDate(y.getDate()-w),$(o.calendar.drawDayColumns(y,w,!0)).prependTo(c),ct=$(o.calendar.drawDayHeaders(y,w)).prependTo(r.find("ul")),n=i.find(".app-calendar-day"),lt=r.find("li"),n.length>k&&(n.slice(k,n.length).remove(),r.find("li").slice(k,n.length).remove()),i.css("marginLeft",(p.position().left-rt)*-1),r.css("marginLeft",h.position().left*-1),f&&o.resize(i,r,f);else if(u>n.width()*(n.length-2)){p=n.last();rt=p.position().left;y=t(p);y.setDate(y.getDate()+1);$(o.calendar.drawDayColumns(y,w,!0)).appendTo(c);$(o.calendar.drawDayHeaders(y,w)).appendTo(r.find("ul"));var lt=r.find("li"),ut=n.length+w,st=0,et=0;ut>k&&(nt=n.slice(0,ut-k),tt=r.find("li").slice(0,ut-k),st=nt.width()*nt.length,et=tt.width()*tt.length,nt.remove(),tt.remove());i.css("marginLeft",parseInt(i.css("marginLeft"),10)+st-v);r.css("marginLeft",parseInt(r.css("marginLeft"),10)+et);f&&o.resize(i,r,f)}else{function ht(){f&&f.length&&f.scrollLeft()!=ft&&o.calendar.resizeScroller(i,f)}v!=0?i.animate({marginLeft:it},{duration:ot,done:ht}):ht()}e.is(".current-day-column")&&i.addClass("app-has-current-day");d();vt=0},250)},updateDayHeader:function(n,i,r){var a=n.find(".app-calendar-day"),v=r&&r.length?r:b(a),u=t(v),s=b(i.find("ul li")),e=t(s),o=s,h,c,l;return i.find("li .visible-day").removeClass("visible-day"),h=i.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"] > a > div',u.getFullYear(),u.getMonth(),u.getDate())),h.addClass("visible-day"),u.setDate(u.getDate()-f[u.getDay()]),e.setDate(e.getDate()-f[e.getDay()]),e.getTime()!=u.getTime()&&(o=i.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"]',u.getFullYear(),u.getMonth(),u.getDate())),o.length&&(c=parseInt(i.css("marginLeft"),10),l=c-o.position().left,i.css("marginLeft",l))),this.calendar.updateHeader(i.closest(".app-bar-calendar")),o},addData:function(n,t,i){var f=this.calendar.getBlockByDate(n,t,"day"),r=f.find("ul.app-calendar-eventlist"),e=this.calendar.dataView._keyFields[0],u=this.calendar.dataView.extension().commandRow(),o=u?u[e.Index]:null;r.empty();typeof i!="boolean"&&this.calendar.drawDayData(r,t,i,o)},resizeData:function(n){var t=this.calendar,i=n.find(".app-calendar-day");i.each(function(){var i=$(this),n=i.find("li.app-event:not(.app-event-preview)");n.length&&t.resizeDayData(n)})},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-dayview"),t;i.length&&(t=i.find("div.app-calendar-day.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},getNextDate:function(n,i){var u=this.calendar.getMostVisibleBlock(),r=t(u);return r.setDate(r.getDate()+i),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-dayview > .app-calendar-day-grid > .app-calendar-day")}};ni=function(n){this.calendar=n};ni.prototype={draw:function(n,t){var e,w,u,v;t.setDate(t.getDate()-f[t.getDay()]);n.find(".app-calendar-weekview").remove();var i=$('<div class="app-calendar-weekview"><\/div>').appendTo(n),s=this.calendar,y=i.closest(".app-echo").length>0,h=y?7:a.week,c=i.closest(".app-presenter"),b=i.closest(".app-wrapper"),l=c.data("cal-header"),p=c.data("cal-footer"),r=new Date(t.getTime());return r.setDate(r.getDate()-h),l.find(".app-week-header").remove(),e=$('<div class="app-week-header"><\/div>').appendTo(l),w=$("<ul>"+s.drawDayHeaders(r,h*3)+"<\/ul>").appendTo(e),ht(e),u='<div class="app-calendar-week-grid"><div class="current-time-line"><div class="dot"><\/div><\/div>',u+=s.drawTimeColumn(r),u+=s.drawDayColumns(r,h*3,!1),u+="<\/div>",i.html(u),v=i.find(".app-calendar-week-grid").hide(),this.resize(i,e,p),this.scroll({view:i,date:t,enhancePrecision:!0}),this.validateCurrentDay(i,v),o(),i},showHeaderAndFooter:function(n,t){n.find(".app-day-header").hide();n.find(".app-week-header").show();n.find(".app-month-header").hide();$app.touch.bar("show",t);this.calendar.lastDayScrollTop=this.calendar.scrollable().scrollTop()},_timelineDot:function(n,t){var o=this.calendar.scrollable(),u=n.find(".app-calendar-week-grid"),f,i=u.find(".current-time-line .dot"),e,r;t?(r=i.show().width(),f=u.find(".current-day-column"),f.length&&(e=f.offset().left-o.offset().left-r/2+parseInt(u.css("margin-left")),e+r<o.width()-r*3?setTimeout(function(){i.css("marginLeft",e).show()}):i.hide())):i.hide()},resize:function(n,t,i){t.is(".app-week-header")||(t=t.find(".app-week-header"));var u=n.closest(".app-echo").length>0,a=n.find(".app-calendar-week-grid"),v=n.find(".app-calendar-week-grid > div:not(.current-time-line):not(.app-calendar-time) > div"),r=t.find("li"),y=this.calendar.scrollable(),p=y[0].scrollWidth-nt,f=Math.floor(p/7),e=f*(r.length+1)+nt,s=b(r),w=u?0:s.position().left,k=u?0:parseInt(t.css("marginLeft"),10)*-1;if(r.width(f),r.closest("ul").css("visibility",""),v.width(f),a.width(e).fadeIn(),n.height(c),!u){var d=s.position().left,h=w-d,l=k-h;this._timelineDot(n,!0);h!=0&&(n.css("marginLeft",l*-1),t.css("marginLeft",l*-1));i!=null&&this.calendar.resizeScroller(n,i,e);this.resizeData(n)}o()},scroll:function(t){var a,v,e,y;t.date.setDate(t.date.getDate()-f[t.date.getDay()]);var s=this,r=s.calendar,u=t.view,p=t.animate,i=t.date,h=r.dataView.extension().commandRow(),c=u.closest(".app-presenter"),w=r.scrollable(),b=c.data("cal-header").find(".app-week-header"),k=c.data("cal-footer"),l=r.getBlockByDate(u,i);l.length&&(a=parseInt(u.css("marginLeft"),10),v=l.position().left-nt,s._scroll(u,b,v-a,k,p));t.enhancePrecision&&(h?(y=h[r.activeCalendar.date.Index],e=o(y,"find")):e=i.getHours()==0&&i.getMinutes()==0&&i.getSeconds()==0&&i.getMilliseconds()==0?r.lastDayScrollTop||o():o(i,"find"),n.scroll(w,e))},_scroll:function(i,r,u,f,e){function st(){h.updateHeader(ut);k||(u<lt?at():b.position().left<ct?vt():o.validateCurrentDay(i,c));f&&f.length&&f.scrollLeft()!=u&&h.resizeScroller(i,f);d(rt);o._timelineDot(i,!0)}function y(n,t,i){var r=i.getDate();n.attr("data-cal-year",i.getFullYear()).attr("data-cal-month",i.getMonth()).attr("data-cal-day",r).data("calendar-colors",t.data("calendar-colors")).find("ul").empty().append(t.find("ul li"));n[0].className=t[0].className}function ht(n,t){var i=t.getDate();n.attr("data-cal-year",t.getFullYear()).attr("data-cal-month",t.getMonth()).attr("data-cal-day",i);n.data("calendar-colors",null);n.find("ul").empty().removeClass("data-loaded");n[0].className="app-calendar-day";w(t)&&n.addClass("current-day-column")}function at(){k=!0;var p=s.first(),nt=c.find(".current-time-line"),f=t(p),a=!1;f.setDate(f.getDate()-g);var b=r.find("li"),e=s.slice(0,7),l=s.slice(7,14),d=s.slice(14,21),n=new Date(f);return b.each(function(){var r=$(this),t=r.find("a div"),i=n.getDate();t.text(i);r.attr("data-cal-year",n.getFullYear()).attr("data-cal-month",n.getMonth()).attr("data-cal-day",i);w(n)?t.addClass("app-current-day"):t.removeClass("app-current-day");n.setDate(i+1)}),n=t(l.first()),d.each(function(t){y($(this),l.eq(t),n);n.setDate(n.getDate()+1)}),n=t(e.first()),l.each(function(t){y($(this),e.eq(t),n);n.setDate(n.getDate()+1)}),n=f,e.each(function(){ht($(this),n);var t=h.cache.select(n);t&&(o.addData(i,n,t),a=!0);n.setDate(n.getDate()+1)}),o.validateCurrentDay(i,c),a&&o.resizeData(i),u-=v,u>0&&(u=0),i.css("marginLeft",u),r.css("marginLeft",u),v}function vt(){k=!0;var p=s.first(),nt=c.find(".current-time-line"),e=t(p),a=!1;e.setDate(e.getDate()+g);var b=r.find("li"),d=s.slice(0,7),l=s.slice(7,14),f=s.slice(14,21),n=new Date(e);return b.each(function(){var r=$(this),t=r.find("a div"),i=n.getDate();t.text(i);r.attr("data-cal-year",n.getFullYear()).attr("data-cal-month",n.getMonth()).attr("data-cal-day",i);w(n)?t.addClass("app-current-day"):t.removeClass("app-current-day");n.setDate(i+1)}),n=t(l.first()),d.each(function(t){y($(this),l.eq(t),n);n.setDate(n.getDate()+1)}),n=t(f.first()),l.each(function(t){y($(this),f.eq(t),n);n.setDate(n.getDate()+1)}),n=t(f.last()),n.setDate(n.getDate()+1),f.each(function(){ht($(this),n);var t=h.cache.select(n);t&&(o.addData(i,n,t),a=!0);n.setDate(n.getDate()+1)}),o.validateCurrentDay(i,c),u-=v,a&&o.resizeData(i),u>0&&(u*=-1),i.css("marginLeft",u),r.css("marginLeft",u),v}var p,tt,it;n.animate()||(e=!1);var o=this,h=o.calendar,rt=h.scrollable(),ct=rt.width(),c=i.find(".app-calendar-week-grid"),s=c.find(".app-calendar-day"),ut=r.closest(".app-bar-calendar"),b=s.last(),l=b.width(),pt=b.position().left-nt+l,k=!1,et=r.find("li:first-of-type"),wt=t(et),lt=et.width()+2,bt=yt.week,g=a.week,v=l*g;o._timelineDot(i,!1);h.updateHeader(ut);e==!0?(p=u%l,tt=u*-1+(p>l/2?p-l:p),r.animate({marginLeft:tt},ot),i.animate({marginLeft:tt},ot,function(){setTimeout(function(){st()})})):(it=u*-1,r.css("marginLeft",it),i.css("marginLeft",it),clearTimeout(ft),ft=setTimeout(st,250))},addData:function(n,t,i){var f=this.calendar.dataView._keyFields[0],u=this.calendar.dataView.extension().commandRow(),e=u?u[f.Index]:null,o=this.calendar.getBlockByDate(n,t,"day"),r=o.find("ul.app-calendar-eventlist");r.empty();r.data("calendar-event-count",i.count||0);this.calendar.drawDayData(r,t,i,e)},resizeData:function(n){var t=this.calendar,i=n.find(".app-calendar-day");i.each(function(){var i=$(this),n=i.find("li.app-event:not(.app-event-preview)");n.length&&t.resizeDayData(n)})},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-weekview"),t;i.length&&(t=i.find("div.app-calendar-day.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},validateCurrentDay:function(n,t){n.is(".app-has-current-day")?t.find(".current-day-column").length||n.removeClass("app-has-current-day"):t.find(".current-day-column").length&&n.addClass("app-has-current-day")},getNextDate:function(n,i){var e=this.calendar.getMostVisibleBlock(),r=t(e),u=f[r.getDay()];return u==0?r.setDate(r.getDate()+i*7):r.setDate(r.getDate()+(i==-1?u*-1:7-u)),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-weekview > .app-calendar-week-grid > .app-calendar-day")}};ti=function(n){this.calendar=n};ti.prototype={draw:function(n,t){var e,w,y,rt,u,it,p,ut;n.find(".app-calendar-monthview").remove();var r=$('<div class="app-calendar-monthview"><\/div>').hide().appendTo(n),ft=this.calendar,s=r.closest(".app-echo").length>0,g=r.closest(".app-presenter"),c=g.data("cal-header"),l=s?0:a.month,nt=t.getMonth(),f=new Date(t.getFullYear(),nt),v,it;for(f.setMonth(f.getMonth()-l),v=f.getMonth(),c.find(".app-month-header").remove(),e=$('<div class="app-month-header"><\/div>'),w=$("<ul><\/ul>").appendTo(e),u=0;u<7;u++){var o=tt[u],b=i.DayNames[o],k=i.AbbreviatedDayNames[o],d=$('<li><span class="letter-day">'+k.substring(0,1)+'<\/span><span class="abbr-day">'+k+'<\/span><span class="full-day">'+b+"<\/span><\/li").attr("title",b);(o==0||o==6)&&d.addClass("app-calendar-weekend");d.appendTo(w)}for(ht(e),e.appendTo(c),$app.touch.bar("show",c),r.fadeIn(),y=$('<div class="app-calendar-load-at-top"><\/div>').appendTo(r),rt=$('<a href="#" class="dv-load-at-top ui-btn"/>').appendTo(y).text(h.Loading),s&&y.hide(),u=l*-1;u<=l;u++)it=this.drawMonth(f).appendTo(r),f.setMonth(v+1),v=f.getMonth();return this.resize(r),p=$('<div class="app-calendar-load-at-bottom"><\/div>').appendTo(r),ut=$('<a href="#" class="dv-load-at-bottom ui-btn">Load more<\/a>').appendTo(p).text(h.Loading),s&&p.hide(),this.scroll({date:t,view:r}),r},showHeaderAndFooter:function(n,t){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").show();$app.touch.bar("hide",t)},resize:function(n,t,i,r){var o=n.closest(".app-wrapper"),u=n.find(".app-calendar-month"),f=u.find("table"),e=o.height()-u.first().find(".app-calendar-month-header").outerHeight();r&&u.removeClass("data-loaded");f.height(e);f.each(function(){var t=$(this),n=t.find("tr");n.height(e/n.length)});this.calendar.navigateDate&&!this.calendar.preventNavigate&&this.scroll({view:n,date:this.calendar.navigateDate})},scroll:function(t){function o(){n.fetchOnDemand();d(i)}var s=this,h=t.date,u=s.calendar,i=u.scrollable(),c=t.view.closest("div.app-presenter"),a=c.data("cal-header"),r=u.getBlockByDate(t.view,t.date),f=r.find(".app-calendar-month-header");if(r){r=r.find('td[data-cal-day="'+h.getDate()+'"]');var l=i.find(".app-presenter-instruction"),e=Math.abs(r.position().top),e=f.offset().top-i.offset().top+f.outerHeight(!0)-l.outerHeight(!0)+i.scrollTop();t.animate?n.animatedScroll(i,e,o):(n.scroll(i,e),o())}},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-monthview"),t;i.length&&(t=i.find("div.app-calendar-month.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},drawMonth:function(n){var s=n.getMonth(),c=i.MonthNames[s],h=$('<div class="app-calendar-month"><\/div>').attr("data-cal-year",n.getFullYear()).attr("data-cal-month",s),l=$('<h1 class="app-calendar-month-header">').appendTo(h),y=$("<table><\/table>").appendTo(h),o,r;s==0?l.text(String.format("{0} {1}",c,n.getFullYear())):l.text(c);var t=new Date(n.getFullYear(),n.getMonth(),1),u=f[t.getDay()],e=new Date(n.getFullYear(),n.getMonth()+1,1),a=f[e.getDay()],v;for(a!=0&&e.setDate(e.getDate()+(6-a)+1),u!=0&&t.setDate(t.getDate()-u);t<e;){if(o=t.getDay(),u=f[o],u==0&&(v=$("<tr><\/tr>").appendTo(y)),r=$("<td><\/td>").appendTo(v),(o==0||o==6)&&r.addClass("app-calendar-weekend"),t.getMonth()==n.getMonth()){r.html("&nbsp;");r.attr("data-cal-day",t.getDate());var p=$('<a class="ui-btn"><\/a>').appendTo(r),w=$("<span><\/span>").text(t.getDate()).appendTo(p),b=$("<ul><\/ul>").appendTo(r),k=$('<li class="app-calendar-month-more"><\/li>').appendTo(b);g.setHours(0,0,0,0)==t.setHours(0,0,0,0)&&w.addClass("app-current-day")}else r.html("&nbsp;");t.setDate(t.getDate()+1)}return h},addData:function(t,i,r){var h=this.calendar,a=h.getBlockByDate(t,i,"month"),ot=h.dataView,st=ot._keyFields[0],ht=h.activeCalendar,u=h.dataView.extension().commandRow(),b=u?u[st.Index]:null,v=u?u[ht.date.Index]:null,it,y,ct=a.find("td").first(),lt=a.find("td > a").first(),rt=a.find("ul"),k,et;rt.hide();it=ct.outerHeight()-lt.height();rt.show();for(k in r){var d=r[k],g=d.count,c=null,p=a.find('td[data-cal-day="'+k+'"] ul'),o=0,w,l=$('<li class="app-calendar-month-more"><\/li>');for(y=!1,p.empty().data("calendar-event-count",g);o<5;){if(u=d.rows[o],!u)break;var at=u[0],i=u[1],nt=u[2],ut=u[3],tt=u[4],ft=e(i,!1,!0);nt&&(ft+="-"+e(nt,!1,!0));var vt=String.format('<span class="app-event-time">{0}<\/span> {1}',ft,tt?tt:s.Data.NullValueInForms),f=$('<li class="app-event"><\/li>').data("data-context",u),yt=h.getEventTitle(i,nt,tt,ut),pt=h.activeCalendar.colorMap.className(ut);if(n.desktop()&&f.addClass("app-draggable").attr("draggable","true"),c||(c=i),b&&b==at&&(f.addClass("app-calendar-selected"),w=f),f.addClass(pt),f.html(vt),f.attr("title",yt),f.appendTo(p),o++,p.height()>it&&g!=1){f.remove();y=!0;o--;break}}(y||o<d.count)&&(l.appendTo(p),y&&(et=l.prev(),et.length&&(l.prev().remove(),o--)),l.html(String.format(fr,g-o)),b&&v&&v.getDate()==c.getDate()&&v.getMonth()==c.getMonth()&&v.getFullYear()==c.getFullYear()&&(w&&(!w||w.is(":visible"))||l.addClass("app-calendar-selected")))}},getNextDate:function(n,i){var u=this.calendar,e=u.getMostVisibleBlock(),r=t(e),n,f;return r.setMonth(r.getMonth()+i),n=u.getVisibleView(),f=u.getBlockByDate(n,r),f.length||(i==1?n.find(".dv-load-at-bottom").trigger("vclick"):n.find(".dv-load-at-top").trigger("vclick")),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-monthview > .app-calendar-month")}};ii=function(n){this.calendar=n};ii.prototype={draw:function(n,t){var r,c,f,l;n.find(".app-calendar-yearview").remove();var i=$('<div class="app-calendar-yearview"><\/div>').hide().appendTo(n),u=i.closest(".app-echo").length>0,e=u?0:a.year,o=t.getFullYear(),s=$('<div class="app-calendar-load-at-top"><\/div>').appendTo(i),v=$('<a href="#" class="dv-load-at-top ui-btn"/>').appendTo(s).text(h.Loading);for(u&&s.hide(),r=o-e;r<=o+e;r++)c=this.drawYear(new Date(r,0)).appendTo(i);return i.fadeIn(),f=$('<div class="app-calendar-load-at-bottom"><\/div>').appendTo(i),l=$('<a href="#" class="dv-load-at-bottom ui-btn">Load more<\/a>').appendTo(f).text(h.Loading),u&&f.hide(),this.scroll({view:i,date:t}),i},showHeaderAndFooter:function(n,t){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").hide();$app.touch.bar("hide",t)},drawYear:function(n){for(var h,r,u,o,s,f=n.getFullYear(),e='<div class="app-calendar-year" data-cal-year="'+f+'"><h1>'+f+"<\/h1>",t=0;t<=11;t++){for(h=i.AbbreviatedMonthNames[t].toUpperCase(),r='<div class="app-calendar-month" data-cal-month="'+t+'"><a class="ui-btn app-calendar-month-header">'+h+"<\/a><table><thead>",u=0;u<7;u++)r+="<th>"+i.ShortestDayNames[tt[u]].substr(0,1)+"<\/th>";r+="<\/thead><tbody>";r+=wi(f,t);e+=r+"<\/tbody><\/table><\/div>"}return e+='<div class="app-clear-fix"><\/div><\/div>',o=$(e),s=this.calendar.cache.select(n),s&&this.addData(null,n,s,o.addClass("data-loaded")),o},addData:function(n,t,i,r){var f=this.calendar,e=r||f.getBlockByDate(n,t,"year"),u,o,s;e.find("td.app-has-data").removeClass("app-has-data").attr("title",null);for(u in i)o=i[u],s=e.find('div[data-cal-month="'+u+'"]'),s.find("td").each(function(){var t=$(this),i=t.text(),n;i.trim().length&&(n=o[i],n&&n.count&&t.addClass("app-has-data").attr("title",String.format("{0} ({1})",f.activeCalendar.date.Label,n.count)))})},scroll:function(t){function o(){n.fetchOnDemand();u.updateHeader(l);d(i)}var s=this,h=t.date,u=s.calendar,i=u.scrollable(),c=t.view.closest("div.app-presenter"),l=c.data("cal-header"),r=u.getBlockByDate(t.view,t.date),e,f;r&&(r=r.find('div.app-calendar-month[data-cal-month="'+h.getMonth()+'"]'),e=i.find(".app-presenter-instruction"),f=r.offset().top+i.scrollTop()-i.offset().top-e.outerHeight(),t.animate?n.animatedScroll(i,f,o):(n.scroll(i,f),o()))},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-yearview"),t;i.length&&(t=i.find("div.app-calendar-year.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-has-data").removeClass("app-has-data").attr("title",null))},resize:function(n){this.calendar.navigateDate&&this.scroll({view:n,date:this.calendar.navigateDate})},getNextDate:function(n,i){var u=this.calendar,e=u.getMostVisibleBlock(),r=t(e),n,f;return r.setYear(r.getFullYear()+i),n=u.getVisibleView(),f=u.getBlockByDate(n,r),f.length||(i==1?n.find(".dv-load-at-bottom").trigger("vclick"):n.find(".dv-load-at-top").trigger("vclick")),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-yearview > .app-calendar-year")}};ri=function(n){this.calendar=n};ri.prototype={draw:function(n,t){var i=n.find(".app-calendar-agendaview");i.length||(i=$('<div class="app-calendar-agendaview"><\/div>').appendTo(n));var r=this,f=this.calendar,p=f.activeCalendar,w=f.dataView,l=i.closest(".app-echo").length>0,e=new Date(t),u=i.find(".app-calendar-agenda-list"),v=u.length&&i.is(".data-loaded"),y=i.closest(".app-wrapper"),a=y.find(".app-presenter-instruction"),o=i.find(".app-calendar-load-at-top"),s=i.find(".app-calendar-load-at-bottom"),c=i.find(".app-echo-footer");return l?i.height(f.echoMaxHeight):a.css("visibility","hidden"),v||(u.length||(u=$('<ul class="app-calendar-agenda-list"><\/ul>').hide().appendTo(i)),l?c.length||(c=$('<div class="app-echo-footer"><div class="app-echo-container-see-all"><a class="ui-btn-icon-left ui-btn ui-icon-carat-r dv-action-see-all"/><\/div><\/div>').hide().appendTo(i)):(o.length||(o=$('<div class="app-calendar-load-at-top"><\/div>').hide().prependTo(i),$('<a href="#" class="dv-load-at-top ui-btn"/>').text(h.Loading).appendTo(o)),s.length||(s=$('<div class="app-calendar-load-at-bottom"><\/div>').hide().appendTo(i),$('<a href="#" class="dv-load-at-bottom ui-btn"><\/a>').text(h.Loading).appendTo(s)))),f.cache.clearAgenda(),r.minPage=0,r.maxPage=0,r.todayLoaded=!1,r.lastDate=e,r.loadData(i,e,0,function(n,f){r.loadData(i,e,-1,function(h,v){var y;u.empty();var it={"0":n[0],"-1":h["-1"]},w=r.drawData(i,e,it),b=r.calendar.cache.select(1),k=r.calendar.cache.select(-2);if(u.show(),i.fadeIn().css("height",""),l){var d=w[0],rt=w[1],g=f+v,nt=d+rt,p=v-d+1,tt=p+nt-1;nt!=g&&(y=c.find(".dv-action-see-all"),y.empty(),c.show(),$('<span class="app-btn-see-all"/>').appendTo(y).text(lt.SeeAll).attr("title",lt.SeeAll),$('<span class="app-info"/>').appendTo(y).attr({"data-start-index":p,"data-end-index":tt}).html(String.format(ct.ShowingItems,p,tt,g)))}else a.css("visibility",""),b&&b.length==0||s.show(),k&&k.length==0||o.show(),r.scroll({view:i,date:t})})}),i},showHeaderAndFooter:function(n,t){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").hide();$app.touch.bar("hide",t)},getNextDate:function(n,i){var u=this.calendar.scrollable(),s=u.scrollTop(),f=this.calendar.getFirstVisibleBlock(u),h=n.find(".app-calendar-agenda-list li:not(.app-calendar-month-header)").first(),e,o,r;return t(f).getTime()==t(h).getTime()?(e=n.find(".dv-load-at-top"),e.is(":visible")&&e.trigger("vclick")):i==1&&s+u.height()>u[0].scrollHeight-20&&(o=n.find(".dv-load-at-bottom"),o.is(":visible")&&o.trigger("vclick")),r=i==1?f.next():f.prev(),r.is(".app-calendar-month-header")&&(r=i==1?r.next():r.prev()),r.length?t(r):t(f)},scroll:function(i){var s=this.calendar,f=i.view||s.getVisibleView(),e=i.date,o;if(!f.hasClass("data-loaded")){this.draw(f.closest(".app-calendar"),e);return}var u=s.scrollable(),l=f.closest(".app-presenter"),y=l.data("cal-header"),r=s.getBlockByDate(f,e),h=this.getBlocks().first(),a=t(h),v=u.find(".app-presenter-instruction");if(r.length)r=r.closest(".app-agenda-day-list");else for(r=h;r.length&&t(r)<=e;)r=r.next(),r.is(".app-calendar-month-header")&&(r=r.next());if(r.length){function c(){n.fetchOnDemand();d(u)}o=0;bt(e,a)||(o=u.scrollTop()+r.offset().top-u.offset().top-v.height());i.animate?n.animatedScroll(u,o,c):(n.scroll(u,o),c())}},resize:function(n){this.calendar.navigateDate&&this.scroll({view:n,date:this.calendar.navigateDate})},clear:function(n){n||(n=this.calendar.getViews().filter(".app-calendar-agendaview"));n.removeClass("data-loaded");n.find(".app-calendar-load-at-top, .app-calendar-load-at-bottom").hide();this.todayLoaded=!1;this.calendar.cache.clearAgenda()},loadData:function(n,t,i,r){var c;t||(t=this.lastDate);var f=this,u=f.calendar,s=u.activeCalendar,e=u.dataView,y=n.closest(".app-echo").length>0,p=n.find(".app-calendar-agenda-list"),h=i<0,a=h?it(e,s.date,s.end,null,t):it(e,s.date,s.end,t,null),v=s.date.Name+(h?" desc":" asc"),o={},l=i>=0?i:Math.abs(i)-1;i>f.maxPage?f.maxPage=i:i<f.minPage&&(f.minPage=i);c=u.cache.select(i);c?(o[i]=c,r?r(o):f.drawData(n,t,o)):(u.loadingData=!0,$app.execute({controller:e._controller,view:e._viewId,command:"Select",_filter:a,sort:v,pageSize:pt,pageIndex:l,requiresRowCount:!0,tags:e.get_tags(),success:function(s){var c;if(u.loadingData=!1,c=s[e._controller],u.mode=="agenda"){var v=l!=0&&c.length>60?c.splice(0,pt):[],a=c.splice(0,pt),y=c;h?(v.reverse(),a.reverse(),y.reverse(),u.cache.insert(i-1,y),u.cache.insert(i,a),i!=-1&&u.cache.insert(i+1,v)):(i!=0&&u.cache.insert(i-1,v),u.cache.insert(i,a),u.cache.insert(i+1,y));o[i]=a;r?r(o,s.totalRowCount):f.drawData(n,t,o,s.totalRowCount)}},error:function(n){u.loadingData=!1;$app.alert(String.format("{0}",n.get_message()))}}))},drawData:function(t,r,u){function bt(n,t){var p=b&&n[b.Name],r=n[ri],u=n[yt],o=pt&&n[pt],v=st&&n[st],w=f.colorMap.className(v),y=g.getDayList(h,r,t?"prepend":"append"),i=$("<li><\/li>").attr("data-cal-page",ft),k=$('<span class="app-event-time"><\/span>').appendTo(i),l=e(r),a=$('<div class="app-event"><\/div>').text(u?u:s.Data.NullValueInForms).data("data-context",n).appendTo(i);return a.attr("title",c.getEventTitle(r,o,u,v)).addClass(w),nt&&nt==p&&a.addClass("app-calendar-selected"),o&&(l+=" - "+e(o)),k.text(l),$('<div class="app-event-time"><\/div>').text(l).appendTo(a),t?i.prependTo(y):i.appendTo(y),i}var g=this,c=g.calendar,h=t.find(".app-calendar-agenda-list"),ti=c.scrollable(),ii=t.closest(".app-echo").length>0,f=c.activeCalendar,vt=c.dataView,ri=f.date.Name,yt=f.text.Name,st=f.color&&f.color.Name,pt=f.end&&f.end.Name,b=c.dataView._keyFields[0],wt=c.dataView.extension().commandRow(),nt=wt?wt[b.Index]:null,tt=c.getMostVisibleBlock(),ui=tt?tt.position().top:0,v,ht,lt,at,ft,et,ot,l,a,dt;if(f.text.AliasName&&f.text.AliasName.length&&(v=vt.findField(f.text.AliasName),v&&(yt=v.Name)),f.color&&f.color.AliasName&&f.color.AliasName.length&&(v=vt.findField(f.color.AliasName),v&&(st=v.Name)),ii){for(var a=u[0],l=u["-1"],fi=l.length&&l[0][b.Name],p=0,k=0,w=!0,it=!0,kt=c.echoMaxHeight-t.find(".app-echo-footer").height(),ei=a.length+l.length,d=0,o,rt;(h.outerHeight(!0)<kt||d<3)&&d<ei;){if(a.length<=p&&(w=!1),l.length<=k){if(a.length<=p)break;w=!0;it=!1}ht=w&&!it?a[p++]:l[k++];ht?(d++,bt(ht,!w)):(w?p--:k--,w=!1);it&&(it=!1)}g.validateToday(h,h.children(),r);o=h.find(".app-agenda-day-list:first");rt=o.attr("data-cal-year");o.length&&rt!=(new Date).getFullYear().toString()&&$("<h1/>").appendTo($('<li class="app-calendar-month-header" data-cal-year="'+rt+'" data-cal-month="'+o.attr("data-cal-month")+'"/>').insertBefore(o)).text(rt);for(var ct=!1,o=h.find("li.app-agenda-day-list").first(),ut=o.find("li").first();h.outerHeight(!0)>kt&&d>3;)lt=ut.find(".app-event").data("data-context"),at=lt&&lt[b.Name],nt&&(at==nt||at==fi)?ct=!0:(ut.remove(),d--,o.find("li").length==0&&(o.remove(),ct?p--:k--)),ct?(o=h.find("li.app-agenda-day-list").last(),ut=o.find("li").last()):(o=h.find("li.app-agenda-day-list").first(),ut=o.find("li").first());return[k,p]}for(ft in u){if(et=u[ft],ot=ft<0,!et.length){l=t.find(".app-calendar-load-at-top a.ui-btn");a=t.find(".app-calendar-load-at-bottom a.ui-btn");ot?(l.text("").removeClass("dv-load-at-top"),a.is(".dv-load-at-bottom")||a.hide()):(a.text("").removeClass("dv-load-at-bottom"),l.is(".dv-load-at-top")||l.hide());continue}for(dt in et)bt(et[dt],ot)}var gt=c.getBlocks(),ni=[],oi=y.getFullYear();gt.each(function(){var f=$(this),r=f.attr("data-cal-year"),u=f.attr("data-cal-month"),e=r+"-"+u,n;if(ni[e])return!0;for(monthHeader=t.find(String.format('li.app-calendar-month-header[data-cal-year="{0}"][data-cal-month="{1}"]',r,u)),monthHeader.length||(monthHeader=$(String.format('<li class="app-calendar-month-header ui-btn" data-cal-year="{0}" data-cal-month="{1}"><h1>{2}<\/h1><\/li>',r,u,i.MonthNames[u])).insertBefore(f),r!=oi&&monthHeader.find("h1").text(i.MonthNames[u]+" "+r)),n=f.prev();n.length;){if(n.attr("data-cal-year")!=r||n.attr("data-cal-month")!=u){monthHeader.insertBefore(n.next());break}n=n.prev()}ni[e]=!0});g.validateToday(h,gt,r);t.addClass("data-loaded");tt&&ot&&n.scroll(ti,tt.position().top-ui)},validateToday:function(n,i,r){var f,v,h;if(!this.todayLoaded){var c=i.first(),y=c.length?t(c):r,l=i.last(),p=l.length?t(l):r,b=y<g&&g<p,u,s;if(b||w(r)){if(this.todayLoaded=!0,f=this.getDayList(n,g,"search"),f.find(".app-time-line-container").length)return;var k=f.parents("li[data-cal-year]"),a=new Date,o=$('<li class="app-time-line-container"><\/li>').appendTo(f),d=$('<span class="app-event-time"><\/span>').text(e(a)).appendTo(o);for(timeLine=$('<div class="current-time-line"><div class="dot">&nbsp;<\/div><\/div>').appendTo(o),k.addClass("app-has-current-day"),u=o.prev();u.length;){if(v=u.find(".app-event"),h=v.data("data-context"),h&&h[this.calendar.activeCalendar.date.Name]>a)s=u;else break;u=u.prev()}s&&o.insertBefore(s)}}},removeData:function(n,t){n.find('.app-calendar-agenda-list li[data-cal-page="'+t+'"]').remove();t==this.maxPage?(n.find(".app-calendar-load-at-bottom .ui-btn").addClass("dv-load-at-bottom").text(h.Loading).show(),this.maxPage--):t==this.minPage&&(n.find(".app-calendar-load-at-top .ui-btn").addClass("dv-load-at-top").text(h.Loading).show(),this.minPage++);this.removeEmptyRows(n)},getDayList:function(n,r,u){var s=this.calendar.getBlockByDate(n,r),e,y,l,h;if(!s.length){var f=$('<li class="app-agenda-day-list"><\/li>').attr("data-cal-year",r.getFullYear()).attr("data-cal-month",r.getMonth()).attr("data-cal-day",r.getDate()),a=i.AbbreviatedDayNames[r.getDay()],p=$(String.format('<h2 class="ui-btn"><span class="app-calendar-daynumbig">{2}<\/span><span class="app-calendar-dayname">{0}<\/span> <span class="app-calendar-monthname">{1}<\/span> <span class="app-calendar-daynum">{2}<\/span><\/h2>',a,i.AbbreviatedMonthNames[r.getMonth()],r.getDate())).appendTo(f).attr("title",String.format("{0:"+i.LongDatePattern+"}",r)),v=$('<div class="app-calendar-day"><\/div>').appendTo(f),o=new Date,c=new Date;if(o.setDate(o.getDate()-1),c.setDate(o.getDate()+1),w(r)?f.addClass("app-calendar-agenda-today"):bt(r,o)?f.addClass("app-calendar-agenda-yesterday"):bt(r,c)&&f.addClass("app-calendar-agenda-tomorrow"),u=="prepend")f.prependTo(n);else if(u=="append")f.appendTo(n);else{for(e=n.find("li[data-cal-year]:first"),h=!1;e.length;){if(l=t(e),r<l){f.insertBefore(e);h=!0;break}y=e;e=e.next()}h||f.appendTo(n)}s=$("<ul><\/ul>").appendTo(v);ht(f)}return s},removeEmptyRows:function(n){n.find(".app-calendar-agenda-list > li").each(function(){var i=$(this),e=i.is(".app-calendar-month-header"),r=t(i),u,f;e?(u=n.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day]',r.getFullYear(),r.getMonth())),u.length==0&&i.remove()):(f=i.find("ul .app-event"),f.length==0&&i.remove())})},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-agendaview > .app-calendar-agenda-list > li:not(.app-calendar-month-header)")}};$app.touch.presenter("register",{name:"calendar",icon:function(){return"calendar"},text:function(){return u.Text},supports:di,show:function(n){var t=$app.find(n.id);t&&t.calendar&&t.calendar.show(n)},hide:function(t){var i=n.dataView();i&&i.calendar&&i.calendar.hide(t)},dispose:function(t){var i=n.dataView();i&&i.calendar&&(i.calendar.dispose(t),delete i.calendar)}});ui=function(n,t){this.dataView=n;this.calendar=n.calendar;this.calendars=t;this.cache={};this.showMonths=1};ui.prototype={getActiveCalendar:function(){return this.calendar?this.calendar.activeCalendar:this.calendars[Object.keys(this.calendars)[0]]},attach:function(n){var r=this.dataView,f,e;if(!r){this.detach(n);return}if(this.calendar||(this.calendar=this.dataView.calendar),this.lastFilter=r.combinedFilter().slice(),!r.get_isTagged("calendar-mini-disabled")){r.get_isTagged("calendar-mini-twomonths")&&(this.showMonths=2);var t=n.find(".app-calendar-plugin"),o=r.extension().commandRow(),i=this.calendar?this.calendar.navigateDate||this.calendar.lastDate:null,h=this.getActiveCalendar(),v=h.date;if(i=o?new Date(o[v.Index]):null,(!i||isNaN(i.getTime()))&&(i=new Date),t.length)t.is(":visible")||t.addClass("app-show-request");else{if(this.attached)return;this.attached=!0;t=$('<div class="app-calendar-plugin app-show-request"><\/div>').prependTo(n.find(".ui-panel-inner"));var c=$('<div class="app-calendar-plugin-header"><div>&nbsp;<\/div><\/div>').appendTo(t),p=$('<a href="#" class="app-calendar-plugin-loadleft ui-btn ui-btn-corner-all ui-btn-icon-notext ui-icon-carat-l"><\/a>').attr("title",s.Pager.Previous).prependTo(c),w=$('<a href="#" class="app-calendar-plugin-loadright ui-btn ui-btn-corner-all ui-btn-icon-notext ui-icon-carat-r"><\/a>').attr("title",s.Pager.Next).appendTo(c),y=$('<div class="app-month-container"><\/div>').attr("data-cal-month",i.getMonth()).attr("data-cal-year",i.getFullYear()).appendTo(t),b=$('<a class="ui-btn ui-btn-icon-none app-has-droparrow app-calendar-plugin-fieldselector"><\/a>').appendTo(t),l=$('<div class="app-calendar-color-legend"><p class="app-item-desc app-item-desc-before"><\/p><ol><\/ol><\/div>').attr("data-calendar-for",h.name).appendTo(t).hide(),a=$('<a class="ui-btn ui-btn-icon-none app-has-droparrow app-legend-toggle"><\/a>').appendTo(l),k=$('<p class="app-item-desc app-item-desc-after"><\/p>').appendTo(l);for($('<span class="app-see-more"><\/span>').text(s.Mobile.More).appendTo(a),$('<span class="app-see-less"><\/span>').text(u.Less).appendTo(a),f=0;f<this.showMonths;f++)e=$("<div><\/div>").appendTo(y),f==0&&e.addClass("app-first-month"),f==this.showMonths-1&&e.addClass("app-last-month"),i.setMonth(i.getMonth()+1)}return this.refresh(!0),t}},setDate:function(t){var i=n.sidebar().find(".app-calendar-plugin");i.length&&(i.find(".app-month-container").attr("data-cal-year",t.getFullYear()).attr("data-cal-month",t.getMonth()),this.refresh())},refresh:function(r){var p=n.sidebar(),h=p.find(".app-calendar-plugin"),e,y,g,nt;if(h.length&&this.dataView){var u=this,o=this.dataView,w=o.combinedFilter(),l=h.find(".app-month-container"),s=t(l),a=h.find(".app-month-container > div"),rt=a.first(),b=t(rt),ut=s.getMonth(),c=h.find(".app-calendar-plugin-header div"),ot=c.text(),k=$.mobile.activePage.find(".app-wrapper"),d=k.find(".app-calendar"),ft=d.length&&d.is(":visible"),et=u.getActiveCalendar(),v=et.date;(s.getFullYear()!=b.getFullYear()||s.getMonth()!=b.getMonth())&&(r=!0,e=new Date(s),c.html(String.format(ur,i.MonthNames[e.getMonth()],s.getFullYear())),y=c.find("a"),g=y.first().outerWidth()+y.eq(2).outerWidth(),g>c.innerWidth()-60&&c.html(String.format('<a class="ui-btn app-has-droparrow app-month-picker">{0}<\/a> <a class="ui-btn app-has-droparrow app-year-picker">{1}<\/a>',i.AbbreviatedMonthNames[e.getMonth()],s.getFullYear())),a.empty(),a.each(function(n){var t=$(this),l="<table><thead>",w=c.outerWidth(!0)-2*h.find(".app-calendar-plugin-header a.app-calendar-plugin-loadleft").width(),r,a,o,f,s;for(n!=0&&(r=$("<div><\/div>").appendTo(t),a=u.getMonthHeader(e),r.text(a[0]),r[0].scrollWidth>r.innerWidth()&&r.text(a[1])),o=0;o<7;o++){var v=tt[o],y=i.ShortestDayNames[v],p=i.DayNames[v];l+='<th title="'+p+'">'+y+"<\/th>"}l+="<\/thead><tbody>"+wi(e.getFullYear(),e.getMonth(),!0)+"<\/tbody><\/table>";f=$(l).appendTo(t);t.is(".app-first-month")||f.find("td.app-prev-month").addClass("app-day-hidden");t.is(".app-last-month")||f.find("td.app-next-month").addClass("app-day-hidden");f.find("tr").filter(function(){return!$(this).find("td:not(.app-day-hidden), th").length}).addClass("app-week-hidden");s=f.find("td.app-current-day");s.length&&s.html('<span class="app-current-day">'+s.text()+"<\/span>");t.attr("data-cal-month",e.getMonth()).attr("data-cal-year",e.getFullYear());e.setMonth(e.getMonth()+1)}));nt=this.getActiveCalendar().date.Label;h.find(".app-calendar-plugin-fieldselector").text(nt);clearTimeout(vi);vi=setTimeout(function(){var r,f,i,n;if(ft){if(p.is(":visible")){if(a.find(".app-selected").removeClass("app-selected"),r=u.calendar,f=r.getMostVisibleBlock(k),!f)return;if(i=t(f),n=u.findMonthByDate(i),!n||!n.length)return;switch(r.mode){case"year":case"month":n.find("table tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7}).addClass("app-selected");break;case"week":u.findDayCell(n,i).parent().addClass("app-selected");break;case"day":u.findDayCell(n,i).addClass("app-selected")}}}else a.find(".app-selected").removeClass("app-selected"),w.length&&$(w).each(function(){var f=this,t,s,n;if(f.startsWith(v.Name)){if(t=/(\w+):(=|\$between\$)(%js%"\\\/Date\(-?\d+?\)\\\/")/.exec(f),!t)return!1;var i=o.convertStringToFieldValue(v,t[3]),h=u.findMonthByDate(i),r=new Date(i),e=t[2]=="=";return(r.setDate(i.getDate()+(e?1:7)),r.setSeconds(-1),s=u.findMonthByDate(r),!h.length&&!s.length)?!0:(n=u.findDayCell(l,i).add(u.findDayCell(l,r)),n&&n.length&&(e?n.addClass("app-selected"):n.parent().addClass("app-selected")),!1)}})},450);u.lastFilter=o.combinedFilter().slice();r&&o.get_viewType(o._id)=="Grid"&&(clearTimeout(hi),hi=setTimeout(function(){function e(n){$(n).each(function(){var t=this[1],n=this[0];if(t&&t!=0){n.indexOf(", ")<0&&(n=n+", "+n);var i=/(\d+), (\d+)/.exec(n),r=parseInt(i[1],10)-1,f=i[2],e=new Date(s.getFullYear(),r,f),o=u.findDayCell(l,e);o.addClass("app-has-data").attr("title",String.format("{0} ({1})",v.Label,t))}})}var r,n;if(l.find(".app-has-data").removeClass("app-has-data").attr("title",""),r=String.format("{0}-{1}",s.getFullYear(),ut),n=u.cache[r],n)e(n);else{var t=new Date(s),h=f[t.getDay()],i,c={};h!=0&&t.setDate(t.getDate()-h);i=new Date(t);i.setDate(i.getDate()+7+35*u.showMonths);i.setSeconds(-1);c[v.Name]=["pivot-row1-month-raw","pivot-row2-day"];$app.execute({controller:o._controller,command:"Pivot",view:o._viewId,_filter:it(o,v,null,t,i),sort:"",pivotDefinitions:c,tags:o.get_tags(),success:function(t){var i=t.Pivots.pivot0;i&&(n=u.cache[r]=t.Pivots.pivot0.Data.slice(1),e(n))},error:function(n){$app.alert(String.format("{0}",n.get_message()))}})}},250))}},clearCache:function(){delete this.cache;this.cache={};this.refresh(!0)},findMonthByDate:function(t){if(t)return n.sidebar().find(String.format('.app-calendar-plugin .app-month-container > div[data-cal-year="{0}"][data-cal-month="{1}"]',t.getFullYear(),t.getMonth()))},getMonthHeader:function(n){return[i.MonthNames[n.getMonth()]+" "+n.getFullYear(),i.AbbreviatedMonthNames[n.getMonth()]+" "+n.getFullYear()]},findDayCell:function(n,t){return n.find(String.format('td[data-cal-month="{0}"][data-cal-day="{1}"]:not(.app-day-hidden)',t.getMonth(),t.getDate()))},filterWithoutField:function(n){var t=this.getActiveCalendar().date.Name;return n.filter(function(n){return!n.startsWith(t)}).join("")}};$(document).on("vclick",".app-calendar-plugin",function(r,e){var et=$(r.target),s=et,l=n.dataView(),c=l.calendarPlugin,y=s.closest(".app-calendar-plugin"),b=y.find(".app-month-container"),wi=y.find(".app-calendar-color-legend"),tt=s.closest("table"),pt=c.getActiveCalendar().date,ti,wt,w,p,lt,g,fi,d,li,yi,at,vt,ni,h,a;if(tt.length||(tt=y.find(".app-month-container > div:first-of-type > table")),ti=tt.parent(),h=t(ti),s.is("span.app-current-day")&&(et=s=s.closest("td")),s.is("td")){var d=s.closest("tr"),bi=b.find("tr.app-selected"),ii=b.find("td.app-selected"),ot=d.hasClass("app-selected"),ki=s.hasClass("app-selected"),v=$.mobile.activePage.find(".app-wrapper"),ht=v.find(".app-calendar"),ct="",it=ht.length&&ht.is(":visible"),rt=l.calendar;if(!it&&!ot&&!ii.length||it&&rt.mode=="week"){while(s.is(".app-prev-month"))s=s.next();for(s.length||(s=et);s.is(".app-next-month");)s=s.prev();s.length||(s=et)}if(wt=s.text().trim(),wt.length==0||s.is(".app-day-hidden"))return;if(h.setDate(wt),s.is(".app-prev-month")?(h.setMonth(h.getMonth()-1),c.findMonthByDate(h).length||b.attr("data-cal-month",h.getMonth()).attr("data-cal-year",h.getFullYear())):s.is(".app-next-month")&&(h.setMonth(h.getMonth()+1),c.findMonthByDate(h).length||b.attr("data-cal-month",h.getMonth()).attr("data-cal-year",h.getFullYear())),w=s,it)switch(rt.mode){case"year":p="Month";w=tt.find("tbody tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7});break;case"month":ot?(p="Week",w=d,h.setDate(h.getDate()-f[h.getDay()])):(p="Month",w=tt.find("tbody tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7}));break;case"week":ot?p="Day":(p="Week",w=d,h.setDate(h.getDate()-f[h.getDay()]));break;case"day":ki?(p="Week",w=d,h.setDate(h.getDate()-f[h.getDay()])):p="Day";break;case"agenda":p="Agenda";rt.animate=!0;rt.enhancePrecision=!0}else ii.length?ct=s.is(".app-selected")?"clear":"=":bi.length&&ot?ct="=":(h.setDate(h.getDate()-f[h.getDay()]),lt=new Date(h),lt.setDate(h.getDate()+7),lt.setSeconds(-1),ct="$between$",w=d);return w.addClass("ui-btn-active"),setTimeout(function(){if(w.removeClass("ui-btn-active"),it){if(l.calendar.navigateDate=new Date(h),p.toLowerCase()==rt.mode)n.presenter("show",{id:l._id,name:"calendar",container:v});else{var t=k(v.parent().find(".app-bar-header .app-bar-calendar"),u[p]);t&&t.trigger("vclick")}c.refresh()}else{l.extension()._instructed=!1;c.filtering=!0;switch(ct){case"=":l.applyFieldFilter(pt.Index,"=",[h]);break;case"$between$":l.applyFieldFilter(pt.Index,"$between",[h,lt]);break;case"clear":l.removeFromFilter(pt);l.sync()}c.filtering=!1;c.refresh()}},st),!1}if(s.is(".ui-btn-icon-notext")){s.is(".app-calendar-plugin-loadleft")?h.setMonth(h.getMonth()-c.showMonths):s.is(".app-calendar-plugin-loadright")&&h.setMonth(h.getMonth()+c.showMonths);b.attr("data-cal-year",h.getFullYear());b.attr("data-cal-month",h.getMonth());function ri(){c.refresh(!0)}return e?setTimeout(ri):n.callWithFeedback(s,ri),!1}if(s.is(".app-calendar-plugin-fieldselector")){g=[];$(c.calendars).each(function(){var n=this,t=n.date,i=c.getActiveCalendar().date;g.push({text:t.Label,icon:t==i?"check":"",callback:function(){if(l.calendar.preventNavigate=!0,i!=t){l.removeFromFilter(i);c.calendar.activeCalendar.colorMap.clearFilter();c.calendar.activeCalendar=n;var r=l.viewProp("calendarConfig");r.activeCalendar=n.name;l.viewProp("calendarConfig",r);c.calendar.clear(!0);l.sync()}}})});g.push({},{text:u.Today,icon:"calendar",callback:function(){c.setDate(new Date)}});var l=n.dataView(),v=$.mobile.activePage.find(".app-wrapper"),ht=v.find(".app-calendar"),it=ht.length&&ht.is(":visible"),nt,ui=u.Sync;return it?(y=l.calendar,fi=y.getMostVisibleBlock(v),nt=t(fi)):(d=l.extension().commandRow(),d&&(nt=new Date(d[c.getActiveCalendar().date.Index]))),nt&&!isNaN(nt.getTime())&&(ui=String.format("{0} {1}",i.MonthNames[nt.getMonth()],nt.getFullYear()),g.push({text:ui,icon:"recycle",callback:function(){c.setDate(nt)}})),n.callWithFeedback(s,function(){n.listPopup({anchor:s,iconPos:"left",items:g})}),!1}if(s.is(".app-calendar-color-legend ol li, .app-calendar-color-legend ol li span")){var y=l.calendar,bt=y.activeCalendar.colorMap,di=bt.getVisibleColors().map(function(n){return bt.color(n)}),kt=$("body"),r=s.is(".app-event")?s:s.find(".app-event"),ei=r.attr("class").match(/app-event-color-(\d+)/),oi=kt.attr("class").match(/app-event-filter-color-(\d+)/),si=!0;if(ei){var hi=parseInt(ei[1],10),ci="app-event-filter-color-"+hi,gi=kt.is("."+ci);if(oi&&(li=parseInt(oi[1],10),si=di.indexOf(li)!=-1),bt.clearFilter(),!gi&&si){kt.addClass("app-event-filter "+ci);var v=y.scrollable(),ut=y.getFirstVisibleBlock(v),nr=y.getLastVisibleBlock(v),ai=v.position().top,tr=ai+v.height(),ft,dt,gt=!1,vi=!1;do yi=ut.find(".app-event.app-event-color-"+hi),yi.each(function(){var n=$(this),t=n.offset().top;if(t<ai)(y.mode=="month"||!ft||ft.offset().top<t)&&(ft=n);else return t+n.height()>tr?(dt=n,gt=!0,!1):(vi=!0,gt=!0,!1)}),ut=ut.next();while(!gt&&ut!=nr&&ut.length);if(!vi&&(dt||ft)){at=dt||ft;switch(y.mode){case"day":case"week":ni=at.data("data-context");ni&&(h=ni[1],vt=o(h,"find"));break;case"month":case"agenda":vt=v.scrollTop()+at.offset().top-v.position().top+(at.height()-v.height())/2}vt!=null&&n.animatedScroll(v,vt)}}}return!1}if(s.is(".app-legend-toggle, .app-see-more, .app-see-less"))return n.callWithFeedback(s,function(){wi.toggleClass("app-see-all")}),!1;if(s.is(".app-has-droparrow")){var g=[],pi=h.getMonth(),yt=h.getFullYear();function ir(n){b.attr("data-cal-month",n);c.refresh(!0)}function rr(n){b.attr("data-cal-year",n);c.refresh(!0)}if(s.is(".app-month-picker"))for(a=0;a<12;a++)g.push({text:i.MonthNames[a],icon:pi==a?"check":!1,visible:pi==a?!0:!1,callback:ir,context:a});else for(a=yt-10;a<=yt+10;a++)g.push({text:a,icon:yt==a?"check":!1,visible:yt==a?!0:!1,callback:rr,context:a});return n.callWithFeedback(s,function(){n.listPopup({anchor:s,iconPos:"right",items:g})}),!1}}).on("swipeleft",".app-calendar-plugin-header, .app-calendar-plugin .app-month-container",function(n){var i=$(n.target),r=i.closest(".app-calendar-plugin"),t=r.find(".app-calendar-plugin-loadright");t.length&&(n.preventDefault(),t.trigger("vclick",!0))}).on("swiperight",".app-calendar-plugin-header, .app-calendar-plugin .app-month-container",function(n){var i=$(n.target),r=i.closest(".app-calendar-plugin"),t=r.find(".app-calendar-plugin-loadleft");t.length&&(n.preventDefault(),t.trigger("vclick",!0))});fi=function(n,t,i){this.dataView=n;this.calendar=t;this.map=i;this.map||(this.map={});this.count=0;for(var r in this.map)this.map.hasOwnProperty(r)&&this.count++};fi.prototype={color:function(n){if(n==undefined||n==null)return 0;var t=this,i=this.map[n];return typeof i=="undefined"&&(i=this.map[n]=1+this.count%rr,this.count++,t.calendar.color&&(clearTimeout(ai),ai=setTimeout(function(){t.dataView.viewProp("calendarColorMap-"+t.calendar.color.Name,t.map);t.dataView.calendarPlugin.refresh(!1,!0)},1e3))),i},className:function(n){return"app-event-color-"+this.color(n)},load:function(t){var i=this;clearTimeout(li);li=setTimeout(function(){var h=n.sidebar(),r=h.find(".app-calendar-color-legend"),v=h.find("a.app-legend-toggle"),c=r.find("ol"),u=i.calendar,f=u?u.color:null,l,e,w,a;if(!u||!f||!h.is(":visible")){r.length&&i.hide();return}if(l=f.Label,e=0,t||c.is(":empty")||u.name!=r.attr("data-calendar-for")){var y=i.dataView.calendar.getFirstVisibleBlock(),o=i.getVisibleColors(),p=r.data("calendar-colors")||[];if(!y||!y.hasClass("data-loaded")&&i.dataView.calendar.mode!="agenda")return;if(o.length==p.length&&o.join("")==p.join(""))return;r.data("calendar-colors",o);c.empty();o.forEach(function(n){var r=i.className(n),u=n||s.Data.NullValueInForms,t,f;r&&(t=$("<li><\/li>").text(u),f=$('<span class="app-event">&nbsp;<\/span>').addClass(r).appendTo(t),e++>=pi&&t.addClass("app-hidden"),t.appendTo(c));w=n});r.attr("data-calendar-for",u.name);f.AliasName&&f.AliasName.length&&(a=i.dataView.findField(f.AliasName),a&&(l=a.Label));r.find(".app-item-desc").text(l);e<=pi?v.addClass("app-hidden"):v.removeClass("app-hidden");e!=0&&u.color?r.removeClass("app-hidden"):r.addClass("app-hidden");i.show()}},450)},show:function(){var i=n.sidebar();if(i.is(":visible")&&this.dataView.calendar.mode!="year"){var t=i.find(".app-calendar-color-legend"),r=this.dataView.calendar.scrollable(),u=r.find(".app-calendar"),f=!t.is(":visible");!t.is(".app-hidden")&&u.is(":visible")&&t.find("ol li").length?f&&t.show():this.hide()}},hide:function(){var t=n.sidebar(),i=t.find(".app-calendar-color-legend");i.hide()},getVisibleColors:function(){var f=[],r=this.dataView.calendar,h=r.scrollable(),n=r.getFirstVisibleBlock(h),p=r.getLastVisibleBlock(h),e=r.mode=="agenda",c=e?r.activeCalendar.color.AliasName||r.activeCalendar.color.Name:3,i,l,u,a,v,o,y,s;if(r.mode!="year")while(n&&n.length){if(i=n.data("calendar-colors"),!i&&(n.hasClass("data-loaded")||e)){if(i=[],l=t(n),e)a=n.find(".app-event"),a.each(function(){var t=$(this).data("data-context"),n=t[c];i.indexOf(n)==-1&&i.push(n)});else{u=r.cache.select(l);for(v in u){o=u[v].rows||u.rows;for(y in o)s=o[y][c],i.indexOf(s)==-1&&i.push(s);if(r.mode.match(/day|week/))break}}n.data("calendar-colors",i)}if(i&&i.forEach(function(n){f.indexOf(n)==-1&&f.push(n)}),n[0]==p[0])break;n=n.next()}return f.sort()},clearFilter:function(){for(var t=[],n=0;n<=23;n++)t.push("app-event-filter app-event-filter-color-"+n);$("body").removeClass(t.join(" "))}}}();